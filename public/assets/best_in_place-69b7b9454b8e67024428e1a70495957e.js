function BestInPlaceEditor(e){this.element=e,this.initOptions(),this.bindForm(),this.initNil(),jQuery(this.activator).bind("click",{editor:this},this.clickHandler)}BestInPlaceEditor.prototype={activate:function(){var e="";e=this.isNil()?"":this.original_content?this.original_content:this.sanitize?this.element.text():this.element.html(),this.oldValue=this.isNil()?"":this.element.html(),this.display_value=e,jQuery(this.activator).unbind("click",this.clickHandler),this.activateForm(),this.element.trigger(jQuery.Event("best_in_place:activate"))},abort:function(){this.activateText(this.oldValue),jQuery(this.activator).bind("click",{editor:this},this.clickHandler),this.element.trigger(jQuery.Event("best_in_place:abort")),this.element.trigger(jQuery.Event("best_in_place:deactivate"))},abortIfConfirm:function(){return this.useConfirm?(confirm("Are you sure you want to discard your changes?")&&this.abort(),void 0):(this.abort(),void 0)},update:function(){var e=this;if(this.formType in{input:1,textarea:1}&&this.getValue()==this.oldValue)return this.abort(),!0;if(e.ajax({type:"post",dataType:"text",data:e.requestData(),success:function(t){e.loadSuccessCallback(t)},error:function(t,i){e.loadErrorCallback(t,i)}}),"select"==this.formType){var t=this.getValue();this.previousCollectionValue=t,jQuery.each(this.values,function(i,n){t==n[0]&&e.element.html(n[1])})}else"checkbox"==this.formType?e.element.html(this.getValue()?this.values[1]:this.values[0]):""!==this.getValue()?e.element.text(this.getValue()):e.element.html(this.nil);e.element.trigger(jQuery.Event("best_in_place:update"))},activateForm:function(){alert("The form was not properly initialized. activateForm is unbound")},activateText:function(e){this.element.html(e),this.isNil()&&this.element.html(this.nil)},initOptions:function(){var e=this;e.element.parents().each(function(){$parent=jQuery(this),e.url=e.url||$parent.attr("data-url"),e.collection=e.collection||$parent.attr("data-collection"),e.formType=e.formType||$parent.attr("data-type"),e.objectName=e.objectName||$parent.attr("data-object"),e.attributeName=e.attributeName||$parent.attr("data-attribute"),e.activator=e.activator||$parent.attr("data-activator"),e.okButton=e.okButton||$parent.attr("data-ok-button"),e.okButtonClass=e.okButtonClass||$parent.attr("data-ok-button-class"),e.cancelButton=e.cancelButton||$parent.attr("data-cancel-button"),e.cancelButtonClass=e.cancelButtonClass||$parent.attr("data-cancel-button-class"),e.nil=e.nil||$parent.attr("data-nil"),e.inner_class=e.inner_class||$parent.attr("data-inner-class"),e.html_attrs=e.html_attrs||$parent.attr("data-html-attrs"),e.original_content=e.original_content||$parent.attr("data-original-content"),e.collectionValue=e.collectionValue||$parent.attr("data-value")}),e.element.parents().each(function(){var t=this.id.match(/^(\w+)_(\d+)$/i);t&&(e.objectName=e.objectName||t[1])}),e.url=e.element.attr("data-url")||e.url||document.location.pathname,e.collection=e.element.attr("data-collection")||e.collection,e.formType=e.element.attr("data-type")||e.formtype||"input",e.objectName=e.element.attr("data-object")||e.objectName,e.attributeName=e.element.attr("data-attribute")||e.attributeName,e.activator=e.element.attr("data-activator")||e.element,e.okButton=e.element.attr("data-ok-button")||e.okButton,e.okButtonClass=e.element.attr("data-ok-button-class")||e.okButtonClass||"",e.cancelButton=e.element.attr("data-cancel-button")||e.cancelButton,e.cancelButtonClass=e.element.attr("data-cancel-button-class")||e.cancelButtonClass||"",e.nil=e.element.attr("data-nil")||e.nil||"â€”",e.inner_class=e.element.attr("data-inner-class")||e.inner_class||null,e.html_attrs=e.element.attr("data-html-attrs")||e.html_attrs,e.original_content=e.element.attr("data-original-content")||e.original_content,e.collectionValue=e.element.attr("data-value")||e.collectionValue,e.sanitize=e.element.attr("data-sanitize")?"true"==e.element.attr("data-sanitize"):!0,e.useConfirm=e.element.attr("data-use-confirm")?"false"!=e.element.attr("data-use-confirm"):!0,"select"!=e.formType&&"checkbox"!=e.formType||null===e.collection||(e.values=jQuery.parseJSON(e.collection))},bindForm:function(){this.activateForm=BestInPlaceEditor.forms[this.formType].activateForm,this.getValue=BestInPlaceEditor.forms[this.formType].getValue},initNil:function(){""===this.element.html()&&this.element.html(this.nil)},isNil:function(){return""===this.element.html()||this.element.html()===this.nil},getValue:function(){alert("The form was not properly initialized. getValue is unbound")},sanitizeValue:function(e){return jQuery.trim(e)},requestData:function(){csrf_token=jQuery("meta[name=csrf-token]").attr("content"),csrf_param=jQuery("meta[name=csrf-param]").attr("content");var e="_method=put";return e+="&"+this.objectName+"["+this.attributeName+"]="+encodeURIComponent(this.getValue()),void 0!==csrf_param&&void 0!==csrf_token&&(e+="&"+csrf_param+"="+encodeURIComponent(csrf_token)),e},ajax:function(e){return e.url=this.url,e.beforeSend=function(e){e.setRequestHeader("Accept","application/json")},jQuery.ajax(e)},loadSuccessCallback:function(e){if(e=jQuery.trim(e),e&&""!=e){var t=jQuery.parseJSON(jQuery.trim(e));null!==t&&t.hasOwnProperty("display_as")&&(this.element.attr("data-original-content",this.element.text()),this.original_content=this.element.text(),this.element.html(t.display_as)),this.element.trigger(jQuery.Event("best_in_place:success"),e),this.element.trigger(jQuery.Event("ajax:success"),e)}else this.element.trigger(jQuery.Event("best_in_place:success")),this.element.trigger(jQuery.Event("ajax:success"));jQuery(this.activator).bind("click",{editor:this},this.clickHandler),this.element.trigger(jQuery.Event("best_in_place:deactivate")),null!==this.collectionValue&&"select"==this.formType&&(this.collectionValue=this.previousCollectionValue,this.previousCollectionValue=null)},loadErrorCallback:function(e,t){this.activateText(this.oldValue),this.element.trigger(jQuery.Event("best_in_place:error"),[e,t]),this.element.trigger(jQuery.Event("ajax:error"),e,t),jQuery(this.activator).bind("click",{editor:this},this.clickHandler),this.element.trigger(jQuery.Event("best_in_place:deactivate"))},clickHandler:function(e){e.preventDefault(),e.data.editor.activate()},setHtmlAttributes:function(){var e=this.element.find(this.formType);if(this.html_attrs){var t=jQuery.parseJSON(this.html_attrs);for(var i in t)e.attr(i,t[i])}}},BestInPlaceEditor.forms={input:{activateForm:function(){var e=jQuery(document.createElement("form")).addClass("form_in_place").attr("action","javascript:void(0);").attr("style","display:inline"),t=jQuery(document.createElement("input")).attr("type","text").attr("name",this.attributeName).val(this.display_value);null!==this.inner_class&&t.addClass(this.inner_class),e.append(t),this.okButton&&e.append(jQuery(document.createElement("input")).attr("type","submit").attr("class",this.okButtonClass).attr("value",this.okButton)),this.cancelButton&&e.append(jQuery(document.createElement("input")).attr("type","button").attr("class",this.cancelButtonClass).attr("value",this.cancelButton)),this.element.html(e),this.setHtmlAttributes(),this.element.find("input[type='text']")[0].select(),this.element.find("form").bind("submit",{editor:this},BestInPlaceEditor.forms.input.submitHandler),this.cancelButton&&this.element.find("input[type='button']").bind("click",{editor:this},BestInPlaceEditor.forms.input.cancelButtonHandler),this.element.find("input[type='text']").bind("blur",{editor:this},BestInPlaceEditor.forms.input.inputBlurHandler),this.element.find("input[type='text']").bind("keyup",{editor:this},BestInPlaceEditor.forms.input.keyupHandler),this.blurTimer=null,this.userClicked=!1},getValue:function(){return this.sanitizeValue(this.element.find("input").val())},inputBlurHandler:function(e){e.data.editor.okButton?e.data.editor.blurTimer=setTimeout(function(){e.data.editor.userClicked||e.data.editor.abort()},500):e.data.editor.cancelButton?e.data.editor.blurTimer=setTimeout(function(){e.data.editor.userClicked||e.data.editor.update()},500):e.data.editor.update()},submitHandler:function(e){e.data.editor.userClicked=!0,clearTimeout(e.data.editor.blurTimer),e.data.editor.update()},cancelButtonHandler:function(e){e.data.editor.userClicked=!0,clearTimeout(e.data.editor.blurTimer),e.data.editor.abort(),e.stopPropagation()},keyupHandler:function(e){27==e.keyCode&&e.data.editor.abort()}},date:{activateForm:function(){var e=this,t=jQuery(document.createElement("form")).addClass("form_in_place").attr("action","javascript:void(0);").attr("style","display:inline"),i=jQuery(document.createElement("input")).attr("type","text").attr("name",this.attributeName).attr("value",this.sanitizeValue(this.display_value));null!==this.inner_class&&i.addClass(this.inner_class),t.append(i),this.element.html(t),this.setHtmlAttributes(),this.element.find("input")[0].select(),this.element.find("form").bind("submit",{editor:this},BestInPlaceEditor.forms.input.submitHandler),this.element.find("input").bind("keyup",{editor:this},BestInPlaceEditor.forms.input.keyupHandler),this.element.find("input").datepicker({onClose:function(){e.update()}}).datepicker("show")},getValue:function(){return this.sanitizeValue(this.element.find("input").val())},submitHandler:function(e){e.data.editor.update()},keyupHandler:function(e){27==e.keyCode&&e.data.editor.abort()}},select:{activateForm:function(){var e=jQuery(document.createElement("form")).attr("action","javascript:void(0)").attr("style","display:inline");selected="",oldValue=this.oldValue,select_elt=jQuery(document.createElement("select")).attr("class",null!==this.inned_class?this.inner_class:""),currentCollectionValue=this.collectionValue,jQuery.each(this.values,function(e,t){var i=jQuery(document.createElement("option")).val(t[0]).html(t[1]);t[0]==currentCollectionValue&&i.attr("selected","selected"),select_elt.append(i)}),e.append(select_elt),this.element.html(e),this.setHtmlAttributes(),this.element.find("select").bind("change",{editor:this},BestInPlaceEditor.forms.select.blurHandler),this.element.find("select").bind("blur",{editor:this},BestInPlaceEditor.forms.select.blurHandler),this.element.find("select").bind("keyup",{editor:this},BestInPlaceEditor.forms.select.keyupHandler),this.element.find("select")[0].focus()},getValue:function(){return this.sanitizeValue(this.element.find("select").val())},blurHandler:function(e){e.data.editor.update()},keyupHandler:function(e){27==e.keyCode&&e.data.editor.abort()}},checkbox:{activateForm:function(){this.collectionValue=!this.getValue(),this.setHtmlAttributes(),this.update()},getValue:function(){return this.collectionValue}},textarea:{activateForm:function(){width=this.element.css("width"),height=this.element.css("height");var e=jQuery(document.createElement("form")).attr("action","javascript:void(0)").attr("style","display:inline").append(jQuery(document.createElement("textarea")).val(this.sanitizeValue(this.display_value)));this.okButton&&e.append(jQuery(document.createElement("input")).attr("type","submit").attr("value",this.okButton)),this.cancelButton&&e.append(jQuery(document.createElement("input")).attr("type","button").attr("value",this.cancelButton)),this.element.html(e),this.setHtmlAttributes(),jQuery(this.element.find("textarea")[0]).css({"min-width":width,"min-height":height}),jQuery(this.element.find("textarea")[0]).elastic(),this.element.find("textarea")[0].focus(),this.element.find("form").bind("submit",{editor:this},BestInPlaceEditor.forms.textarea.submitHandler),this.cancelButton&&this.element.find("input[type='button']").bind("click",{editor:this},BestInPlaceEditor.forms.textarea.cancelButtonHandler),this.element.find("textarea").bind("blur",{editor:this},BestInPlaceEditor.forms.textarea.blurHandler),this.element.find("textarea").bind("keyup",{editor:this},BestInPlaceEditor.forms.textarea.keyupHandler),this.blurTimer=null,this.userClicked=!1},getValue:function(){return this.sanitizeValue(this.element.find("textarea").val())},blurHandler:function(e){e.data.editor.okButton?e.data.editor.blurTimer=setTimeout(function(){e.data.editor.userClicked||e.data.editor.abortIfConfirm()},500):e.data.editor.cancelButton?e.data.editor.blurTimer=setTimeout(function(){e.data.editor.userClicked||e.data.editor.update()},500):e.data.editor.update()},submitHandler:function(e){e.data.editor.userClicked=!0,clearTimeout(e.data.editor.blurTimer),e.data.editor.update()},cancelButtonHandler:function(e){e.data.editor.userClicked=!0,clearTimeout(e.data.editor.blurTimer),e.data.editor.abortIfConfirm(),e.stopPropagation()},keyupHandler:function(e){27==e.keyCode&&e.data.editor.abortIfConfirm()}}},jQuery.fn.best_in_place=function(){function e(e){return e.data("bestInPlaceEditor")?void 0:(e.data("bestInPlaceEditor",new BestInPlaceEditor(e)),!0)}return jQuery(this.context).delegate(this.selector,"click",function(){var t=jQuery(this);e(t)&&t.click()}),this.each(function(){e(jQuery(this))}),this},function(e){"undefined"==typeof e.fn.elastic&&e.fn.extend({elastic:function(){var t=["paddingTop","paddingRight","paddingBottom","paddingLeft","fontSize","lineHeight","fontFamily","width","fontWeight"];return this.each(function(){function i(e,t){curratedHeight=Math.floor(parseInt(e,10)),s.height()!=curratedHeight&&s.css({height:curratedHeight+"px",overflow:t})}function n(){var e=s.val().replace(/&/g,"&amp;").replace(/  /g,"&nbsp;").replace(/<|>/g,"&gt;").replace(/\n/g,"<br />"),t=o.html().replace(/<br>/gi,"<br />");if(e+"&nbsp;"!=t&&(o.html(e+"&nbsp;"),Math.abs(o.height()+a-s.height())>3)){var n=o.height()+a;n>=l?i(l,"auto"):r>=n?i(r,"hidden"):i(n,"hidden")}}if("textarea"!=this.type)return!1;var s=e(this),o=e("<div />").css({position:"absolute",display:"none","word-wrap":"break-word"}),a=parseInt(s.css("line-height"),10)||parseInt(s.css("font-size"),"10"),r=parseInt(s.css("height"),10)||3*a,l=parseInt(s.css("max-height"),10)||Number.MAX_VALUE,c=0;for(0>l&&(l=Number.MAX_VALUE),o.appendTo(s.parent()),c=t.length;c--;)o.css(t[c].toString(),s.css(t[c].toString()));s.css({overflow:"hidden"}),s.bind("keyup change cut paste",function(){n()}),s.bind("blur",function(){o.height()<l&&(o.height()>r?s.height(o.height()):s.height(r))}),s.on("input paste",function(){setTimeout(n,250)}),n()})}})}(jQuery);