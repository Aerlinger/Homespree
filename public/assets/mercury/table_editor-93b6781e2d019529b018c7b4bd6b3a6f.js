!function(){this.Mercury.tableEditor=function(e,t,i){return Mercury.tableEditor.load(e,t,i),Mercury.tableEditor},jQuery.extend(Mercury.tableEditor,{load:function(e,t,i){return this.table=e,this.cell=t,this.cellContent=null!=i?i:"",this.row=this.cell.parent("tr"),this.columnCount=this.getColumnCount(),this.rowCount=this.getRowCount()},addColumnBefore:function(){return this.addColumn("before")},addColumnAfter:function(){return this.addColumn("after")},addColumn:function(e){var t,i,n,r,s,o,a,l,c,u,h,d;for(null==e&&(e="after"),l=this.cellSignatureFor(this.cell),h=this.table.find("tr"),d=[],t=c=0,u=h.length;u>c;t=++c)o=h[t],a=1,n="after"===e?{right:l.right}:{left:l.left},(r=this.findCellByOptionsFor(o,n))?(s=jQuery("<"+r.cell.get(0).tagName+">").html(this.cellContent),this.setRowspanFor(s,r.height),"before"===e?r.cell.before(s):r.cell.after(s),d.push(t+=r.height-1)):(i=this.findCellByIntersectionFor(o,l))?d.push(this.setColspanFor(i.cell,i.width+1)):d.push(void 0);return d},removeColumn:function(){var e,t,i,n,r,s,o,a,l,c,u,h,d,p,f,m;if(a=this.cellSignatureFor(this.cell),!(a.width>1)){for(s=[],e=[],f=this.table.find("tr"),i=l=0,h=f.length;h>l;i=++l)o=f[i],(r=this.findCellByOptionsFor(o,{left:a.left,width:a.width}))?(s.push(r.cell),i+=r.height-1):(n=this.findCellByIntersectionFor(o,a))&&e.push(n.cell);for(c=0,d=s.length;d>c;c++)t=s[c],jQuery(t).remove();for(m=[],u=0,p=e.length;p>u;u++)t=e[u],m.push(this.setColspanFor(t,this.colspanFor(t)-1));return m}},addRowBefore:function(){return this.addRow("before")},addRowAfter:function(){return this.addRow("after")},addRow:function(e){var t,i,n,r,s,o,a,l,c,u,h,d,p,f,m,g,v;for(null==e&&(e="after"),s=jQuery("<tr>"),(l=this.rowspanFor(this.cell))>1&&"after"===e&&(this.row=jQuery(this.row.nextAll("tr")[l-2])),i=0,m=this.row.find("th, td"),c=0,d=m.length;d>c;c++)t=m[c],n=this.colspanFor(t),r=jQuery("<"+t.tagName+">").html(this.cellContent),this.setColspanFor(r,n),i+=n,(l=this.rowspanFor(t))>1&&"after"===e?this.setRowspanFor(t,l+1):s.append(r);if(i<this.columnCount)for(a=0,g=this.row.prevAll("tr"),u=0,p=g.length;p>u;u++)for(o=g[u],a+=1,v=jQuery(o).find("td[rowspan], th[rowspan]"),h=0,f=v.length;f>h;h++)t=v[h],l=this.rowspanFor(t),l-1>=a&&"before"===e?this.setRowspanFor(t,l+1):l-1>=a&&"after"===e&&(l-1===a?(r=jQuery("<"+t.tagName+">").html(this.cellContent),this.setColspanFor(r,this.colspanFor(t)),s.append(r)):this.setRowspanFor(t,l+1));return"before"===e?this.row.before(s):this.row.after(s)},removeRow:function(){var e,t,i,n,r,s,o,a,l,c,u,h,d,p,f,m,g,v,y,b,w,_,x,k;for(l=!0,s=0,r=0,b=this.row.find("td, th"),u=0,f=b.length;f>u;u++)t=b[u],a=this.rowspanFor(t),s&&a!==s&&(l=!1),(r>a||!r)&&(r=a),s=a;if(l||!(this.rowspanFor(this.cell)>r)){if(r>1)for(i=h=0,w=r-2;w>=0?w>=h:h>=w;i=w>=0?++h:--h)jQuery(this.row.nextAll("tr")[i]).remove();for(_=this.row.find("td[rowspan], th[rowspan]"),d=0,m=_.length;m>d;d++)t=_[d],c=this.cellSignatureFor(t),c.height!==r&&(n=this.findCellByOptionsFor(this.row.nextAll("tr")[r-1],{left:c.left,forceAdjacent:!0}))&&(this.setRowspanFor(t,this.rowspanFor(t)-this.rowspanFor(this.cell)),"before"===n.direction?n.cell.before(jQuery(t).clone()):n.cell.after(jQuery(t).clone()));if(this.columnsFor(this.row.find("td, th"))<this.columnCount)for(o=0,x=this.row.prevAll("tr"),p=0,g=x.length;g>p;p++)for(e=x[p],o+=1,k=jQuery(e).find("td[rowspan], th[rowspan]"),y=0,v=k.length;v>y;y++)t=k[y],a=this.rowspanFor(t),a>o&&this.setRowspanFor(t,a-this.rowspanFor(this.cell));return this.row.remove()}},increaseColspan:function(){var e;return e=this.cell.next("td, th"),!e.length||this.rowspanFor(e)!==this.rowspanFor(this.cell)||this.cellIndexFor(e)>this.cellIndexFor(this.cell)+this.colspanFor(this.cell)?void 0:(this.setColspanFor(this.cell,this.colspanFor(this.cell)+this.colspanFor(e)),e.remove())},decreaseColspan:function(){var e;if(1!==this.colspanFor(this.cell))return this.setColspanFor(this.cell,this.colspanFor(this.cell)-1),e=jQuery("<"+this.cell.get(0).tagName+">").html(this.cellContent),this.setRowspanFor(e,this.rowspanFor(this.cell)),this.cell.after(e)},increaseRowspan:function(){var e,t,i;return i=this.cellSignatureFor(this.cell),t=this.row.nextAll("tr")[i.height-1],t&&(e=this.findCellByOptionsFor(t,{left:i.left,width:i.width}))?(this.setRowspanFor(this.cell,i.height+e.height),e.cell.remove()):void 0},decreaseRowspan:function(){var e,t,i,n;return n=this.cellSignatureFor(this.cell),1!==n.height?(i=this.row.nextAll("tr")[n.height-2],(e=this.findCellByOptionsFor(i,{left:n.left,forceAdjacent:!0}))?(t=jQuery("<"+this.cell.get(0).tagName+">").html(this.cellContent),this.setColspanFor(t,this.colspanFor(this.cell)),this.setRowspanFor(this.cell,n.height-1),"before"===e.direction?e.cell.before(t):e.cell.after(t)):void 0):void 0},getColumnCount:function(){return this.columnsFor(this.table.find("thead tr:first-child, tbody tr:first-child, tfoot tr:first-child").first().find("td, th"))},getRowCount:function(){return this.table.find("tr").length},cellIndexFor:function(e){var t,i,n,r,s,o,a,l,c,u,h,d;if(e=jQuery(e),s=e.parent("tr"),n=this.columnsFor(s.find("td, th")),r=this.columnsFor(e.prevAll("td, th")),n<this.columnCount)for(o=0,h=s.prevAll("tr"),a=0,c=h.length;c>a;a++)for(i=h[a],o+=1,d=jQuery(i).find("td[rowspan], th[rowspan]"),l=0,u=d.length;u>l;l++)t=d[l],this.rowspanFor(t)>o&&this.cellIndexFor(t)<=r&&(r+=this.colspanFor(t));return r},cellSignatureFor:function(e){var t;return t={cell:jQuery(e)},t.left=this.cellIndexFor(e),t.width=this.colspanFor(e),t.height=this.rowspanFor(e),t.right=t.left+t.width,t},findCellByOptionsFor:function(e,t){var i,n,r,s,o,a;for(a=jQuery(e).find("td, th"),s=0,o=a.length;o>s;s++){if(i=a[s],r=this.cellSignatureFor(i),"undefined"!=typeof t.right&&r.right===t.right)return r;if("undefined"!=typeof t.left)if(t.width){if(r.left===t.left&&r.width===t.width)return r}else if(t.forceAdjacent){if(t.forceAdjacent&&r.left>t.left)return n=jQuery(i).prev("td, th"),n.length?(r=this.cellSignatureFor(n),r.direction="after"):r.direction="before",r}else if(r.left===t.left)return r}return t.forceAdjacent?(r.direction="after",r):null},findCellByIntersectionFor:function(e,t){var i,n,r,s,o;for(o=jQuery(e).find("td, th"),r=0,s=o.length;s>r;r++)if(i=o[r],n=this.cellSignatureFor(i),n.right-t.left>=0&&n.right>t.left)return n;return null},columnsFor:function(e){var t,i,n,r;for(i=0,n=0,r=e.length;r>n;n++)t=e[n],i+=this.colspanFor(t);return i},colspanFor:function(e){return parseInt(jQuery(e).attr("colspan"))||1},rowspanFor:function(e){return parseInt(jQuery(e).attr("rowspan"))||1},setColspanFor:function(e,t){return jQuery(e).attr("colspan",t>1?t:null)},setRowspanFor:function(e,t){return jQuery(e).attr("rowspan",t>1?t:null)}})}.call(this);