(function(){this.Mercury.PageEditor=function(){function t(t,e){var i;if(this.saveUrl=null!=t?t:null,this.options=null!=e?e:{},window.mercuryInstance)throw Mercury.I18n("Mercury.PageEditor can only be instantiated once.");this.options.visible!==!1&&"false"!==this.options.visible&&(this.options.visible=!0),this.visible=this.options.visible,this.options.saveDataType===!1||this.options.saveDataType||(this.options.saveDataType="json"),window.mercuryInstance=this,this.regions=[],this.initializeInterface(),(i=jQuery(Mercury.config.csrfSelector).attr("content"))&&(Mercury.csrfToken=i)}return t.prototype.initializeInterface=function(){var t,e,i=this;return this.focusableElement=jQuery("<input>",{"class":"mercury-focusable",type:"text"}).appendTo(null!=(t=this.options.appendTo)?t:"body"),this.iframe=jQuery("<iframe>",{id:"mercury_iframe","class":"mercury-iframe",frameborder:"0",src:"about:blank"}),this.iframe.appendTo(null!=(e=jQuery(this.options.appendTo).get(0))?e:"body"),this.toolbar=new Mercury.Toolbar(jQuery.extend(!0,{},this.options,this.options.toolbarOptions)),this.statusbar=new Mercury.Statusbar(jQuery.extend(!0,{},this.options,this.options.statusbarOptions)),this.resize(),this.iframe.one("load",function(){return i.bindEvents()}),this.iframe.on("load",function(){return i.initializeFrame()}),this.loadIframeSrc(null)},t.prototype.initializeFrame=function(){var t,e;try{if(this.iframe.data("loaded"))return;return this.iframe.data("loaded",!0),this.document=jQuery(this.iframe.get(0).contentWindow.document),jQuery('<style mercury-styles="true">').html(Mercury.config.injectedStyles).appendTo(this.document.find("head")),e=this.iframe.get(0).contentWindow,jQuery.globalEval=function(t){return t&&/\S/.test(t)?(e.execScript||function(t){return e.eval.call(e,t)})(t):void 0},e.Mercury=Mercury,window.History&&History.Adapter&&(e.History=History),this.bindDocumentEvents(),this.resize(),this.initializeRegions(),this.finalizeInterface(),Mercury.trigger("ready"),e.jQuery&&e.jQuery(e).trigger("mercury:ready"),e.Event&&e.Event.fire&&e.Event.fire(e,"mercury:ready"),e.onMercuryReady&&e.onMercuryReady(),this.iframe.css({visibility:"visible"})}catch(i){return t=i,Mercury.notify("Mercury.PageEditor failed to load: %s\n\nPlease try refreshing.",t)}},t.prototype.initializeRegions=function(){var t,e,i,n,s,r,o,a;for(this.regions=[],r=jQuery("["+Mercury.config.regions.attribute+"]",this.document),e=0,n=r.length;n>e;e++)t=r[e],this.buildRegion(jQuery(t));if(this.visible){for(o=this.regions,a=[],i=0,s=o.length;s>i;i++){if(t=o[i],t.focus){t.focus();break}a.push(void 0)}return a}},t.prototype.buildRegion=function(t){var e,i;if(t.data("region"))t=t.data("region");else{if(e=(t.attr(Mercury.config.regions.attribute)||("function"==typeof(i=Mercury.config.regions).determineType?i.determineType(t):void 0)||"unknown").titleize(),"Unknown"===e||!Mercury.Regions[e])throw Mercury.I18n('Region type is malformed, no data-type provided, or "%s" is unknown for the "%s" region.',e,t.attr("id")||"unknown");if(!Mercury.Regions[e].supported)return Mercury.notify("Mercury.Regions.%s is unsupported in this client. Supported browsers are %s.",e,Mercury.Regions[e].supportedText),!1;t=new Mercury.Regions[e](t,this.iframe.get(0).contentWindow),this.previewing&&t.togglePreview()}return this.regions.push(t)},t.prototype.finalizeInterface=function(){var t;return this.santizerElement=jQuery("<div>",{id:"mercury_sanitizer",contenteditable:"true",style:"position:fixed;width:100px;height:100px;min-width:0;top:0;left:-100px;opacity:0;overflow:hidden"}),this.santizerElement.appendTo(null!=(t=this.options.appendTo)?t:this.document.find("body")),this.snippetToolbar&&this.snippetToolbar.release(),this.snippetToolbar=new Mercury.SnippetToolbar(this.document),this.hijackLinksAndForms(),this.visible?void 0:Mercury.trigger("mode",{mode:"preview"})},t.prototype.bindDocumentEvents=function(){return this.document.on("mousedown",function(t){return Mercury.trigger("hide:dialogs"),Mercury.region&&jQuery(t.target).closest("["+Mercury.config.regions.attribute+"]").get(0)!==Mercury.region.element.get(0)?Mercury.trigger("unfocus:regions"):void 0}),jQuery(this.document).bind("keydown",function(t){return t.ctrlKey||t.metaKey?83===t.keyCode?(Mercury.trigger("action",{action:"save"}),t.preventDefault()):void 0:void 0})},t.prototype.bindEvents=function(){var t=this;return Mercury.on("initialize:frame",function(){return setTimeout(t.initializeFrame,100)}),Mercury.on("focus:frame",function(){return t.iframe.focus()}),Mercury.on("focus:window",function(){return setTimeout(function(){return t.focusableElement.focus()},10)}),Mercury.on("toggle:interface",function(){return t.toggleInterface()}),Mercury.on("reinitialize",function(){return t.initializeRegions()}),Mercury.on("mode",function(e,i){return"preview"===i.mode?t.previewing=!t.previewing:void 0}),Mercury.on("action",function(e,i){var n;return n=Mercury.config.globalBehaviors[i.action]||t[i.action],"function"==typeof n?(e.preventDefault(),n.call(t,i)):void 0}),jQuery(window).on("resize",function(){return t.resize()}),jQuery(window).bind("keydown",function(t){return t.ctrlKey||t.metaKey?83===t.keyCode?(Mercury.trigger("action",{action:"save"}),t.preventDefault()):void 0:void 0}),window.onbeforeunload=this.beforeUnload},t.prototype.toggleInterface=function(){var t=this;return this.visible?(this.visible=!1,this.toolbar.hide(),this.statusbar.hide(),this.previewing||Mercury.trigger("mode",{mode:"preview"}),this.previewing=!0,this.resize()):(this.visible=!0,this.iframe.animate({top:this.toolbar.height(!0)},200,"easeInOutSine",function(){return t.resize()}),this.toolbar.show(),this.statusbar.show(),Mercury.trigger("mode",{mode:"preview"}),this.previewing=!1)},t.prototype.resize=function(){var t,e,i;return i=jQuery(window).width(),t=this.statusbar.top(),e=this.toolbar.top()+this.toolbar.height(),Mercury.displayRect={top:e,left:0,width:i,height:t-e,fullHeight:t},this.iframe.css({top:e,left:0,height:t-e}),Mercury.trigger("resize")},t.prototype.iframeSrc=function(t,e){var i,n;return null==t&&(t=null),null==e&&(e=!1),t=(null!=t?t:window.location.href).replace(null!=(n=(i=Mercury.config).editorUrlRegEx)?n:i.editorUrlRegEx=/([http|https]:\/\/.[^\/]*)\/editor\/?(.*)/i,"$1/$2"),t=t.replace(/[\?|\&]mercury_frame=true/gi,""),t=t.replace(/\&_=\d+/gi,""),e?""+t+(t.indexOf("?")>-1?"&":"?")+"mercury_frame=true&_="+(new Date).getTime():t},t.prototype.loadIframeSrc=function(t){return this.document&&this.document.off(),this.iframe.data("loaded",!1),this.iframe.get(0).contentWindow.document.location.href=this.iframeSrc(t,!0)},t.prototype.hijackLinksAndForms=function(){var t,e,i,n,s,r,o,a,l,c;for(a=jQuery("a, form",this.document),c=[],n=0,r=a.length;r>n;n++){for(e=a[n],i=!1,l=Mercury.config.nonHijackableClasses||[],s=0,o=l.length;o>s;s++)t=l[s],jQuery(e).hasClass(t)&&(i=!0);i||""!==e.target&&"_self"!==e.target||jQuery(e).closest("["+Mercury.config.regions.attribute+"]").length?c.push(void 0):c.push(jQuery(e).attr("target","_parent"))}return c},t.prototype.beforeUnload=function(){return Mercury.changes&&!Mercury.silent?Mercury.I18n("You have unsaved changes.  Are you sure you want to leave without saving them first?"):null},t.prototype.getRegionByName=function(t){var e,i,n,s;for(s=this.regions,i=0,n=s.length;n>i;i++)if(e=s[i],e.name===t)return e;return null},t.prototype.save=function(t){var e,i,n,s,r,o;return s=null!=(r=null!=(o=this.saveUrl)?o:Mercury.saveUrl)?r:this.iframeSrc(),e=this.serialize(),e={content:e},"POST"===this.options.saveMethod?i="POST":(i="PUT",e._method=i),Mercury.log("saving",e),n={headers:Mercury.ajaxHeaders(),type:i,dataType:this.options.saveDataType,data:e,success:function(e){return Mercury.changes=!1,Mercury.trigger("saved",e),"function"==typeof t?t():void 0},error:function(t){return Mercury.trigger("save_failed",t),Mercury.notify("Mercury was unable to save to the url: %s",s)}},"form"!==this.options.saveStyle&&(n.data=jQuery.toJSON(e),n.contentType="application/json"),jQuery.ajax(s,n)},t.prototype.serialize=function(){var t,e,i,n,s;for(e={},s=this.regions,i=0,n=s.length;n>i;i++)t=s[i],e[t.name]=t.serialize();return e},t}()}).call(this);