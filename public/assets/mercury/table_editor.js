(function(){this.Mercury.tableEditor=function(e,t,n){return Mercury.tableEditor.load(e,t,n),Mercury.tableEditor},jQuery.extend(Mercury.tableEditor,{load:function(e,t,n){return this.table=e,this.cell=t,this.cellContent=n!=null?n:"",this.row=this.cell.parent("tr"),this.columnCount=this.getColumnCount(),this.rowCount=this.getRowCount()},addColumnBefore:function(){return this.addColumn("before")},addColumnAfter:function(){return this.addColumn("after")},addColumn:function(e){var t,n,r,i,s,o,u,a,f,l,c,h;e==null&&(e="after"),a=this.cellSignatureFor(this.cell),c=this.table.find("tr"),h=[];for(t=f=0,l=c.length;f<l;t=++f)o=c[t],u=1,r=e==="after"?{right:a.right}:{left:a.left},(i=this.findCellByOptionsFor(o,r))?(s=jQuery("<"+i.cell.get(0).tagName+">").html(this.cellContent),this.setRowspanFor(s,i.height),e==="before"?i.cell.before(s):i.cell.after(s),h.push(t+=i.height-1)):(n=this.findCellByIntersectionFor(o,a))?h.push(this.setColspanFor(n.cell,n.width+1)):h.push(void 0);return h},removeColumn:function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v;u=this.cellSignatureFor(this.cell);if(u.width>1)return;s=[],e=[],d=this.table.find("tr");for(n=a=0,c=d.length;a<c;n=++a)o=d[n],(i=this.findCellByOptionsFor(o,{left:u.left,width:u.width}))?(s.push(i.cell),n+=i.height-1):(r=this.findCellByIntersectionFor(o,u))&&e.push(r.cell);for(f=0,h=s.length;f<h;f++)t=s[f],jQuery(t).remove();v=[];for(l=0,p=e.length;l<p;l++)t=e[l],v.push(this.setColspanFor(t,this.colspanFor(t)-1));return v},addRowBefore:function(){return this.addRow("before")},addRowAfter:function(){return this.addRow("after")},addRow:function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g;e==null&&(e="after"),s=jQuery("<tr>"),(a=this.rowspanFor(this.cell))>1&&e==="after"&&(this.row=jQuery(this.row.nextAll("tr")[a-2])),n=0,v=this.row.find("th, td");for(f=0,h=v.length;f<h;f++){t=v[f],r=this.colspanFor(t),i=jQuery("<"+t.tagName+">").html(this.cellContent),this.setColspanFor(i,r),n+=r;if((a=this.rowspanFor(t))>1&&e==="after"){this.setRowspanFor(t,a+1);continue}s.append(i)}if(n<this.columnCount){u=0,m=this.row.prevAll("tr");for(l=0,p=m.length;l<p;l++){o=m[l],u+=1,g=jQuery(o).find("td[rowspan], th[rowspan]");for(c=0,d=g.length;c<d;c++)t=g[c],a=this.rowspanFor(t),a-1>=u&&e==="before"?this.setRowspanFor(t,a+1):a-1>=u&&e==="after"&&(a-1===u?(i=jQuery("<"+t.tagName+">").html(this.cellContent),this.setColspanFor(i,this.colspanFor(t)),s.append(i)):this.setRowspanFor(t,a+1))}}return e==="before"?this.row.before(s):this.row.after(s)},removeRow:function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x;a=!0,s=0,i=0,b=this.row.find("td, th");for(l=0,d=b.length;l<d;l++){t=b[l],u=this.rowspanFor(t),s&&u!==s&&(a=!1);if(u<i||!i)i=u;s=u}if(!a&&this.rowspanFor(this.cell)>i)return;if(i>1)for(n=c=0,w=i-2;0<=w?c<=w:c>=w;n=0<=w?++c:--c)jQuery(this.row.nextAll("tr")[n]).remove();E=this.row.find("td[rowspan], th[rowspan]");for(h=0,v=E.length;h<v;h++){t=E[h],f=this.cellSignatureFor(t);if(f.height===i)continue;if(r=this.findCellByOptionsFor(this.row.nextAll("tr")[i-1],{left:f.left,forceAdjacent:!0}))this.setRowspanFor(t,this.rowspanFor(t)-this.rowspanFor(this.cell)),r.direction==="before"?r.cell.before(jQuery(t).clone()):r.cell.after(jQuery(t).clone())}if(this.columnsFor(this.row.find("td, th"))<this.columnCount){o=0,S=this.row.prevAll("tr");for(p=0,m=S.length;p<m;p++){e=S[p],o+=1,x=jQuery(e).find("td[rowspan], th[rowspan]");for(y=0,g=x.length;y<g;y++)t=x[y],u=this.rowspanFor(t),u>o&&this.setRowspanFor(t,u-this.rowspanFor(this.cell))}}return this.row.remove()},increaseColspan:function(){var e;e=this.cell.next("td, th");if(!e.length)return;if(this.rowspanFor(e)!==this.rowspanFor(this.cell))return;if(this.cellIndexFor(e)>this.cellIndexFor(this.cell)+this.colspanFor(this.cell))return;return this.setColspanFor(this.cell,this.colspanFor(this.cell)+this.colspanFor(e)),e.remove()},decreaseColspan:function(){var e;if(this.colspanFor(this.cell)===1)return;return this.setColspanFor(this.cell,this.colspanFor(this.cell)-1),e=jQuery("<"+this.cell.get(0).tagName+">").html(this.cellContent),this.setRowspanFor(e,this.rowspanFor(this.cell)),this.cell.after(e)},increaseRowspan:function(){var e,t,n;n=this.cellSignatureFor(this.cell),t=this.row.nextAll("tr")[n.height-1];if(t&&(e=this.findCellByOptionsFor(t,{left:n.left,width:n.width})))return this.setRowspanFor(this.cell,n.height+e.height),e.cell.remove()},decreaseRowspan:function(){var e,t,n,r;r=this.cellSignatureFor(this.cell);if(r.height===1)return;n=this.row.nextAll("tr")[r.height-2];if(e=this.findCellByOptionsFor(n,{left:r.left,forceAdjacent:!0}))return t=jQuery("<"+this.cell.get(0).tagName+">").html(this.cellContent),this.setColspanFor(t,this.colspanFor(this.cell)),this.setRowspanFor(this.cell,r.height-1),e.direction==="before"?e.cell.before(t):e.cell.after(t)},getColumnCount:function(){return this.columnsFor(this.table.find("thead tr:first-child, tbody tr:first-child, tfoot tr:first-child").first().find("td, th"))},getRowCount:function(){return this.table.find("tr").length},cellIndexFor:function(e){var t,n,r,i,s,o,u,a,f,l,c,h;e=jQuery(e),s=e.parent("tr"),r=this.columnsFor(s.find("td, th")),i=this.columnsFor(e.prevAll("td, th"));if(r<this.columnCount){o=0,c=s.prevAll("tr");for(u=0,f=c.length;u<f;u++){n=c[u],o+=1,h=jQuery(n).find("td[rowspan], th[rowspan]");for(a=0,l=h.length;a<l;a++)t=h[a],this.rowspanFor(t)>o&&this.cellIndexFor(t)<=i&&(i+=this.colspanFor(t))}}return i},cellSignatureFor:function(e){var t;return t={cell:jQuery(e)},t.left=this.cellIndexFor(e),t.width=this.colspanFor(e),t.height=this.rowspanFor(e),t.right=t.left+t.width,t},findCellByOptionsFor:function(e,t){var n,r,i,s,o,u;u=jQuery(e).find("td, th");for(s=0,o=u.length;s<o;s++){n=u[s],i=this.cellSignatureFor(n);if(typeof t.right!="undefined"&&i.right===t.right)return i;if(typeof t.left!="undefined")if(t.width){if(i.left===t.left&&i.width===t.width)return i}else if(!t.forceAdjacent){if(i.left===t.left)return i}else if(t.forceAdjacent&&i.left>t.left)return r=jQuery(n).prev("td, th"),r.length?(i=this.cellSignatureFor(r),i.direction="after"):i.direction="before",i}return t.forceAdjacent?(i.direction="after",i):null},findCellByIntersectionFor:function(e,t){var n,r,i,s,o;o=jQuery(e).find("td, th");for(i=0,s=o.length;i<s;i++){n=o[i],r=this.cellSignatureFor(n);if(r.right-t.left>=0&&r.right>t.left)return r}return null},columnsFor:function(e){var t,n,r,i;n=0;for(r=0,i=e.length;r<i;r++)t=e[r],n+=this.colspanFor(t);return n},colspanFor:function(e){return parseInt(jQuery(e).attr("colspan"))||1},rowspanFor:function(e){return parseInt(jQuery(e).attr("rowspan"))||1},setColspanFor:function(e,t){return jQuery(e).attr("colspan",t>1?t:null)},setRowspanFor:function(e,t){return jQuery(e).attr("rowspan",t>1?t:null)}})}).call(this);