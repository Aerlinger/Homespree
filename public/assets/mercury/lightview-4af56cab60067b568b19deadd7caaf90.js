(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};this.Mercury.lightview=function(t,e){var i;return null==e&&(e={}),(i=Mercury.lightview).instance||(i.instance=new Mercury.Lightview(t,e)),Mercury.lightview.instance.show(t,e),Mercury.lightview.instance},this.Mercury.Lightview=function(){function e(e,i){this.url=e,this.options=null!=i?i:{},this.hide=t(this.hide,this)}return e.prototype.show=function(t,e){var i=this;return this.url=t||this.url,this.options=e||this.options,this.options.ujsHandling!==!1&&(this.options.ujsHandling=!0),Mercury.trigger("focus:window"),this.initializeLightview(),this.visible?this.update():this.appear(),this.options.content?setTimeout(function(){return i.loadContent(i.options.content)},500):void 0},e.prototype.initializeLightview=function(){return this.initialized?void 0:(this.build(),this.bindEvents(),this.initialized=!0)},e.prototype.build=function(){var t,e;return this.element=jQuery("<div>",{"class":"mercury-lightview loading"}),this.element.html('<h1 class="mercury-lightview-title"><span></span></h1>'),this.element.append('<div class="mercury-lightview-content"></div>'),this.overlay=jQuery("<div>",{"class":"mercury-lightview-overlay"}),this.titleElement=this.element.find(".mercury-lightview-title"),this.options.closeButton&&this.titleElement.append('<a class="mercury-lightview-close"></a>'),this.contentElement=this.element.find(".mercury-lightview-content"),this.element.appendTo(null!=(t=jQuery(this.options.appendTo).get(0))?t:"body"),this.overlay.appendTo(null!=(e=jQuery(this.options.appendTo).get(0))?e:"body")},e.prototype.bindEvents=function(){var t=this;return Mercury.on("refresh",function(){return t.resize(!0)}),Mercury.on("resize",function(){return t.visible?t.position():void 0}),this.overlay.on("click",function(){return t.options.closeButton?void 0:t.hide()}),this.titleElement.find(".mercury-lightview-close").on("click",function(){return t.hide()}),this.options.ujsHandling&&this.element.on("ajax:beforeSend",function(e,i,n){return n.success=function(e){return t.loadContent(e)}}),jQuery(document).on("keydown",function(e){return 27===e.keyCode&&t.visible?t.hide():void 0})},e.prototype.appear=function(){var t=this;return this.showing=!0,this.position(),this.overlay.show().css({opacity:0}),this.overlay.animate({opacity:1},200,"easeInOutSine",function(){return t.setTitle(),t.element.show().css({opacity:0}),t.element.stop().animate({opacity:1},200,"easeInOutSine",function(){return t.visible=!0,t.showing=!1,t.load()})})},e.prototype.resize=function(t){var e,i,n,s,o,r,a=this;return o=t?"visible":"hidden",s=Mercury.displayRect.width,n=Mercury.displayRect.fullHeight,i=this.titleElement.outerHeight(),r=this.contentElement.outerWidth(),(r>s-40||this.options.fullSize)&&(r=s-40),this.contentPane&&this.contentPane.css({height:"auto"}),this.contentElement.css({height:"auto",visibility:o,display:"block"}),e=this.contentElement.outerHeight()+i,(e>n-20||this.options.fullSize)&&(e=n-20),300>r&&(r=300),150>e&&(e=150),this.element.stop().animate({top:(n-e)/2+10,left:(Mercury.displayRect.width-r)/2,width:r,height:e},200,"easeInOutSine",function(){var t;return a.contentElement.css({visibility:"visible",display:"block"}),a.contentPane.length?(a.contentElement.css({height:e-i,overflow:"visible"}),t=a.contentControl.length?a.contentControl.outerHeight():0,a.contentPane.css({height:e-i-t-40}),a.contentPane.find(".mercury-display-pane").css({width:r-40})):a.contentElement.css({height:e-i-30,overflow:"auto"})})},e.prototype.position=function(){var t,e,i,n,s,o;return s=Mercury.displayRect.width,n=Mercury.displayRect.fullHeight,this.contentPane&&this.contentPane.css({height:"auto"}),this.contentElement.css({height:"auto"}),this.element.css({width:"auto",height:"auto",display:"block",visibility:"hidden"}),o=this.contentElement.width()+40,e=this.contentElement.height()+this.titleElement.outerHeight()+30,(o>s-40||this.options.fullSize)&&(o=s-40),(e>n-20||this.options.fullSize)&&(e=n-20),300>o&&(o=300),150>e&&(e=150),i=this.titleElement.outerHeight(),this.contentPane&&this.contentPane.length?(this.contentElement.css({height:e-i,overflow:"visible"}),t=this.contentControl.length?this.contentControl.outerHeight():0,this.contentPane.css({height:e-i-t-40}),this.contentPane.find(".mercury-display-pane").css({width:o-40})):this.contentElement.css({height:e-i-30,overflow:"auto"}),this.element.css({top:(n-e)/2+10,left:(s-o)/2,width:o,height:e,display:this.visible?"block":"none",visibility:"visible"})},e.prototype.update=function(){return this.reset(),this.resize(),this.load()},e.prototype.load=function(){var t=this;return this.setTitle(),this.url?(this.element.addClass("loading"),Mercury.preloadedViews[this.url]?setTimeout(function(){return t.loadContent(Mercury.preloadedViews[t.url])},10):jQuery.ajax(this.url,{headers:Mercury.ajaxHeaders(),type:this.options.loadType||"GET",data:this.options.loadData,success:function(e){return t.loadContent(e)},error:function(){return t.hide(),Mercury.notify("Mercury was unable to load %s for the lightview.",t.url)}})):void 0},e.prototype.loadContent=function(t,e){return null==e&&(e=null),this.initializeLightview(),this.options=e||this.options,this.setTitle(),this.loaded=!0,this.element.removeClass("loading"),this.contentElement.html(t),this.contentElement.css({display:"none",visibility:"hidden"}),this.contentPane=this.element.find(".mercury-display-pane-container"),this.contentControl=this.element.find(".mercury-display-controls"),this.options.afterLoad&&this.options.afterLoad.call(this),this.options.handler&&(Mercury.modalHandlers[this.options.handler]?"function"==typeof Mercury.modalHandlers[this.options.handler]?Mercury.modalHandlers[this.options.handler].call(this):(jQuery.extend(this,Mercury.modalHandlers[this.options.handler]),this.initialize()):Mercury.lightviewHandlers[this.options.handler]&&("function"==typeof Mercury.lightviewHandlers[this.options.handler]?Mercury.lightviewHandlers[this.options.handler].call(this):(jQuery.extend(this,Mercury.lightviewHandlers[this.options.handler]),this.initialize()))),Mercury.config.localization.enabled&&this.element.localize(Mercury.locale()),this.element.find(".lightview-close").on("click",this.hide),this.resize()},e.prototype.setTitle=function(){return this.titleElement.find("span").html(Mercury.I18n(this.options.title))},e.prototype.serializeForm=function(){return this.element.find("form").serializeObject()||{}},e.prototype.reset=function(){return this.titleElement.find("span").html(""),this.contentElement.html("")},e.prototype.hide=function(){return this.showing?void 0:(this.options={},Mercury.trigger("focus:frame"),this.element.hide(),this.overlay.hide(),this.reset(),this.visible=!1)},e}()}).call(this);