(function(){var t={}.hasOwnProperty;this.Mercury.uploader=function(t,e){return Mercury.config.uploading.enabled&&Mercury.uploader.show(t,e),Mercury.uploader},jQuery.extend(Mercury.uploader,{show:function(t,e){return this.options=null!=e?e:{},this.file=new Mercury.uploader.File(t),this.file.errors?(alert("Error: "+this.file.errors),void 0):this.supported()?(Mercury.trigger("focus:window"),this.initialize(),this.appear()):void 0},initialize:function(){return this.initialized?void 0:(this.build(),this.bindEvents(),this.initialized=!0)},supported:function(){var t;return t=new XMLHttpRequest,window.Uint8Array&&window.ArrayBuffer&&!XMLHttpRequest.prototype.sendAsBinary&&(XMLHttpRequest.prototype.sendAsBinary=function(t){var e,i,n,s,r;for(n=new Uint8Array(t.length),i=s=0,r=t.length;r>s;i=++s)e=t[i],n[i]=255&t.charCodeAt(i);return this.send(n.buffer)}),!(!t.upload||!t.sendAsBinary||!Mercury.uploader.fileReaderSupported()&&!Mercury.uploader.formDataSupported())},fileReaderSupported:function(){return!!window.FileReader},formDataSupported:function(){return!!window.FormData},build:function(){var t,e;return this.element=jQuery("<div>",{"class":"mercury-uploader",style:"display:none"}),this.element.append('<div class="mercury-uploader-preview"><b><img/></b></div>'),this.element.append('<div class="mercury-uploader-details"></div>'),this.element.append('<div class="mercury-uploader-progress"><span></span><div class="mercury-uploader-indicator"><div><b>0%</b></div></div></div>'),this.updateStatus("Processing..."),this.overlay=jQuery("<div>",{"class":"mercury-uploader-overlay",style:"display:none"}),this.element.appendTo(null!=(t=jQuery(this.options.appendTo).get(0))?t:"body"),this.overlay.appendTo(null!=(e=jQuery(this.options.appendTo).get(0))?e:"body")},bindEvents:function(){var t=this;return Mercury.on("resize",function(){return t.position()})},appear:function(){var t=this;return this.fillDisplay(),this.position(),this.overlay.show(),this.overlay.animate({opacity:1},200,"easeInOutSine",function(){return t.element.show(),t.element.animate({opacity:1},200,"easeInOutSine",function(){return t.visible=!0,t.loadImage()})})},position:function(){var t,e;return e=this.element.outerWidth(),t=this.element.outerHeight(),this.element.css({top:(Mercury.displayRect.height-t)/2,left:(Mercury.displayRect.width-e)/2})},fillDisplay:function(){var t;return t=[Mercury.I18n("Name: %s",this.file.name),Mercury.I18n("Size: %s",this.file.readableSize),Mercury.I18n("Type: %s",this.file.type)],this.element.find(".mercury-uploader-details").html(t.join("<br/>"))},loadImage:function(){var t=this;return Mercury.uploader.fileReaderSupported()?this.file.readAsDataURL(function(e){return t.element.find(".mercury-uploader-preview b").html(jQuery("<img>",{src:e})),t.upload()}):this.upload()},upload:function(){var t,e,i=this;return e=new XMLHttpRequest,jQuery.each(["onloadstart","onprogress","onload","onabort","onerror"],function(t,n){return e.upload[n]=function(t){return i.uploaderEvents[n].call(i,t)}}),e.onload=function(t){var e,n,s;if(t.currentTarget.status>=400)return i.updateStatus("Error: Unable to upload the file"),Mercury.notify("Unable to process response: %s",t.currentTarget.status),i.hide();try{if(n=Mercury.config.uploading.handler?Mercury.config.uploading.handler(t.target.responseText):jQuery.parseJSON(t.target.responseText),s=n.url||n.image.url,!s)throw"Malformed response from server.";return Mercury.trigger("action",{action:"insertImage",value:{src:s}}),i.hide()}catch(r){return e=r,i.updateStatus("Error: Unable to upload the file"),Mercury.notify("Unable to process response: %s",e),i.hide()}},e.open("post",Mercury.config.uploading.url,!0),e.setRequestHeader("Accept","application/json, text/javascript, text/html, application/xml, text/xml, */*"),e.setRequestHeader("X-Requested-With","XMLHttpRequest"),e.setRequestHeader(Mercury.config.csrfHeader,Mercury.csrfToken),Mercury.uploader.fileReaderSupported()?this.file.readAsBinaryString(function(t){var n;return n=new Mercury.uploader.MultiPartPost(Mercury.config.uploading.inputName,i.file,t),i.file.updateSize(n.delta),e.setRequestHeader("Content-Type","multipart/form-data; boundary="+n.boundary),e.sendAsBinary(n.body)}):(t=new FormData,t.append(Mercury.config.uploading.inputName,this.file.file,this.file.file.name),e.send(t))},updateStatus:function(t,e){var i;return this.element.find(".mercury-uploader-progress span").html(Mercury.I18n(t).toString()),e?(i=Math.floor(100*e/this.file.size)+"%",this.element.find(".mercury-uploader-indicator div").css({width:i}),this.element.find(".mercury-uploader-indicator b").html(i).show()):void 0},hide:function(t){var e=this;return null==t&&(t=0),setTimeout(function(){return e.element.animate({opacity:0},200,"easeInOutSine",function(){return e.overlay.animate({opacity:0},200,"easeInOutSine",function(){return e.overlay.hide(),e.element.hide(),e.reset(),e.visible=!1,Mercury.trigger("focus:frame")})})},1e3*t)},reset:function(){return this.element.find(".mercury-uploader-preview b").html(""),this.element.find(".mercury-uploader-indicator div").css({width:0}),this.element.find(".mercury-uploader-indicator b").html("0%").hide(),this.updateStatus("Processing...")},uploaderEvents:{onloadstart:function(){return this.updateStatus("Uploading...")},onprogress:function(t){return this.updateStatus("Uploading...",t.loaded)},onabort:function(){return this.updateStatus("Aborted"),this.hide(1)},onload:function(){return this.updateStatus("Successfully uploaded...",this.file.size)},onerror:function(){return this.updateStatus("Error: Unable to upload the file"),this.hide(3)}}}),Mercury.uploader.File=function(){function t(t){var e;this.file=t,this.fullSize=this.size=this.file.size||this.file.fileSize,this.readableSize=this.size.toBytes(),this.name=this.file.name||this.file.fileName,this.type=this.file.type||this.file.fileType,e=[],this.size>=Mercury.config.uploading.maxFileSize&&e.push(Mercury.I18n("Too large")),Mercury.config.uploading.allowedMimeTypes.indexOf(this.type)>-1||e.push(Mercury.I18n("Unsupported format")),e.length&&(this.errors=e.join(" / "))}return t.prototype.readAsDataURL=function(t){var e;return null==t&&(t=null),e=new FileReader,e.readAsDataURL(this.file),e.onload=function(){return t?t(e.result):void 0}},t.prototype.readAsBinaryString=function(t){var e;return null==t&&(t=null),e=new FileReader,e.readAsBinaryString(this.file),e.onload=function(){return t?t(e.result):void 0}},t.prototype.updateSize=function(t){return this.fullSize=this.size+t},t}(),Mercury.uploader.MultiPartPost=function(){function e(t,e,i,n){this.inputName=t,this.file=e,this.contents=i,this.formInputs=null!=n?n:{},this.boundary="Boundaryx20072377098235644401115438165x",this.body="",this.buildBody(),this.delta=this.body.length-this.file.size}return e.prototype.buildBody=function(){var e,i,n,s;e="--"+this.boundary,s=this.formInputs;for(i in s)t.call(s,i)&&(n=s[i],this.body+=""+e+'\r\nContent-Disposition: form-data; name="'+i+'"\r\n\r\n'+unescape(encodeURIComponent(n))+"\r\n");return this.body+=""+e+'\r\nContent-Disposition: form-data; name="'+this.inputName+'"; filename="'+this.file.name+'"\r\nContent-Type: '+this.file.type+"\r\nContent-Transfer-Encoding: binary\r\n\r\n"+this.contents+"\r\n"+e+"--"},e}()}).call(this);