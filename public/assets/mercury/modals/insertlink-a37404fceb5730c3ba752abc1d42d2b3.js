(function(){this.Mercury.modalHandlers.insertLink={initialize:function(){var t=this;return this.editing=!1,this.content=null,this.element.find(".control-label input").on("click",this.onLabelChecked),this.element.find(".controls .optional, .controls .required").on("focus",this.onInputFocused),this.element.find("#link_target").on("change",function(){return t.onChangeTarget()}),this.initializeForm(),this.element.find("form").on("submit",function(e){return e.preventDefault(),t.validateForm(),t.valid?(t.submitForm(),t.hide()):(t.resize(),void 0)})},initializeForm:function(){var t,e,i,n,s,r;return this.fillExistingBookmarks(),Mercury.region&&Mercury.region.selection?(r=Mercury.region.selection(),r.textContent&&this.element.find("#link_text").val(r.textContent()),r&&r.commonAncestor&&(t=r.commonAncestor(!0).closest("a")),r.htmlContent&&(n=/<img/.test(r.htmlContent())),n||t&&t.length?(this.element.find("#link_text_container").hide(),n&&(this.content=r.htmlContent()),t&&t.length?(this.editing=t,t.attr("href")&&0===t.attr("href").indexOf("#")?(e=this.element.find("#link_existing_bookmark"),e.val(t.attr("href").replace(/[^#]*#/,"")),e.closest(".control-group").find("input[type=radio]").prop("checked",!0)):this.element.find("#link_external_url").val(t.attr("href")),t.attr("name")&&(s=this.element.find("#link_new_bookmark"),s.val(t.attr("name")),s.closest(".control-group").find("input[type=radio]").prop("checked",!0)),t.attr("target")&&this.element.find("#link_target").val(t.attr("target")),t.attr("href")&&0===t.attr("href").indexOf("javascript:void")?(i=t.attr("href"),this.element.find("#link_external_url").val(i.match(/window.open\('([^']+)',/)[1]),this.element.find("#link_target").val("popup"),this.element.find("#link_popup_width").val(i.match(/width=(\d+),/)[1]),this.element.find("#link_popup_height").val(i.match(/height=(\d+),/)[1]),this.element.find("#popup_options").show()):void 0):!1):!1):void 0},fillExistingBookmarks:function(){var t,e,i,n,s,r;for(t=this.element.find("#link_existing_bookmark"),s=jQuery("a[name]",window.mercuryInstance.document),r=[],i=0,n=s.length;n>i;i++)e=s[i],r.push(t.append(jQuery("<option>",{value:jQuery(e).attr("name")}).text(jQuery(e).text())));return r},onLabelChecked:function(){var t;return t=jQuery(this).closest(".control-label").attr("for"),jQuery(this).closest(".control-group").find("#"+t).focus()},onInputFocused:function(){return jQuery(this).closest(".control-group").find("input[type=radio]").prop("checked",!0)},onChangeTarget:function(){return this.element.find(".link-target-options").hide(),this.element.find("#"+this.element.find("#link_target").val()+"_options").show(),this.resize(!0)},addInputError:function(t,e){return t.after('<span class="help-inline error-message">'+Mercury.I18n(e)+"</span>").closest(".control-group").addClass("error"),this.valid=!1},clearInputErrors:function(){return this.element.find(".control-group.error").removeClass("error").find(".error-message").remove(),this.valid=!0},validateForm:function(){var t,e;return this.clearInputErrors(),e=this.element.find("input[name=link_type]:checked").val(),t=this.element.find("#link_"+e),t.val()||this.addInputError(t,"can't be blank"),this.editing||this.content||(t=this.element.find("#link_text"),t.val())?void 0:this.addInputError(t,"can't be blank")},submitForm:function(){var t,e,i,n,s,r;switch(i=this.element.find("#link_text").val(),n=this.element.find("#link_target").val(),s=this.element.find("input[name=link_type]:checked").val()){case"existing_bookmark":e={href:"#"+this.element.find("#link_existing_bookmark").val()};break;case"new_bookmark":e={name:""+this.element.find("#link_new_bookmark").val()};break;default:e={href:this.element.find("#link_"+s).val()}}switch(n){case"popup":t={width:parseInt(this.element.find("#link_popup_width").val())||500,height:parseInt(this.element.find("#link_popup_height").val())||500,menubar:"no",toolbar:"no"},e.href="javascript:void(window.open('"+e.href+"', 'popup_window', '"+jQuery.param(t).replace(/&/g,",")+"'))";break;default:n&&(e.target=n)}return r={tagName:"a",attrs:e,content:this.content||i},this.editing?Mercury.trigger("action",{action:"replaceLink",value:r,node:this.editing.get(0)}):Mercury.trigger("action",{action:"insertLink",value:r})}}}).call(this);