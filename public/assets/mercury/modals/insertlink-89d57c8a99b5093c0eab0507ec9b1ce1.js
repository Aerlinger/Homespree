(function(){this.Mercury.modalHandlers.insertLink={initialize:function(){var e=this;return this.editing=!1,this.content=null,this.element.find(".control-label input").on("click",this.onLabelChecked),this.element.find(".controls .optional, .controls .required").on("focus",this.onInputFocused),this.element.find("#link_target").on("change",function(){return e.onChangeTarget()}),this.initializeForm(),this.element.find("form").on("submit",function(t){t.preventDefault(),e.validateForm();if(!e.valid){e.resize();return}return e.submitForm(),e.hide()})},initializeForm:function(){var e,t,n,r,i,s;this.fillExistingBookmarks();if(!Mercury.region||!Mercury.region.selection)return;s=Mercury.region.selection(),s.textContent&&this.element.find("#link_text").val(s.textContent()),s&&s.commonAncestor&&(e=s.commonAncestor(!0).closest("a")),s.htmlContent&&(r=/<img/.test(s.htmlContent()));if(!(r||e&&e.length))return!1;this.element.find("#link_text_container").hide(),r&&(this.content=s.htmlContent());if(!e||!e.length)return!1;this.editing=e,e.attr("href")&&e.attr("href").indexOf("#")===0?(t=this.element.find("#link_existing_bookmark"),t.val(e.attr("href").replace(/[^#]*#/,"")),t.closest(".control-group").find("input[type=radio]").prop("checked",!0)):this.element.find("#link_external_url").val(e.attr("href")),e.attr("name")&&(i=this.element.find("#link_new_bookmark"),i.val(e.attr("name")),i.closest(".control-group").find("input[type=radio]").prop("checked",!0)),e.attr("target")&&this.element.find("#link_target").val(e.attr("target"));if(e.attr("href")&&e.attr("href").indexOf("javascript:void")===0)return n=e.attr("href"),this.element.find("#link_external_url").val(n.match(/window.open\('([^']+)',/)[1]),this.element.find("#link_target").val("popup"),this.element.find("#link_popup_width").val(n.match(/width=(\d+),/)[1]),this.element.find("#link_popup_height").val(n.match(/height=(\d+),/)[1]),this.element.find("#popup_options").show()},fillExistingBookmarks:function(){var e,t,n,r,i,s;e=this.element.find("#link_existing_bookmark"),i=jQuery("a[name]",window.mercuryInstance.document),s=[];for(n=0,r=i.length;n<r;n++)t=i[n],s.push(e.append(jQuery("<option>",{value:jQuery(t).attr("name")}).text(jQuery(t).text())));return s},onLabelChecked:function(){var e;return e=jQuery(this).closest(".control-label").attr("for"),jQuery(this).closest(".control-group").find("#"+e).focus()},onInputFocused:function(){return jQuery(this).closest(".control-group").find("input[type=radio]").prop("checked",!0)},onChangeTarget:function(){return this.element.find(".link-target-options").hide(),this.element.find("#"+this.element.find("#link_target").val()+"_options").show(),this.resize(!0)},addInputError:function(e,t){return e.after('<span class="help-inline error-message">'+Mercury.I18n(t)+"</span>").closest(".control-group").addClass("error"),this.valid=!1},clearInputErrors:function(){return this.element.find(".control-group.error").removeClass("error").find(".error-message").remove(),this.valid=!0},validateForm:function(){var e,t;this.clearInputErrors(),t=this.element.find("input[name=link_type]:checked").val(),e=this.element.find("#link_"+t),e.val()||this.addInputError(e,"can't be blank");if(!this.editing&&!this.content){e=this.element.find("#link_text");if(!e.val())return this.addInputError(e,"can't be blank")}},submitForm:function(){var e,t,n,r,i,s;n=this.element.find("#link_text").val(),r=this.element.find("#link_target").val(),i=this.element.find("input[name=link_type]:checked").val();switch(i){case"existing_bookmark":t={href:"#"+this.element.find("#link_existing_bookmark").val()};break;case"new_bookmark":t={name:""+this.element.find("#link_new_bookmark").val()};break;default:t={href:this.element.find("#link_"+i).val()}}switch(r){case"popup":e={width:parseInt(this.element.find("#link_popup_width").val())||500,height:parseInt(this.element.find("#link_popup_height").val())||500,menubar:"no",toolbar:"no"},t.href="javascript:void(window.open('"+t.href+"', 'popup_window', '"+jQuery.param(e).replace(/&/g,",")+"'))";break;default:r&&(t.target=r)}return s={tagName:"a",attrs:t,content:this.content||n},this.editing?Mercury.trigger("action",{action:"replaceLink",value:s,node:this.editing.get(0)}):Mercury.trigger("action",{action:"insertLink",value:s})}}}).call(this);