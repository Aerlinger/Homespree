(function(){this.Mercury.Region=function(){function t(t,e,i){this.element=t,this.window=e,this.options=null!=i?i:{},Mercury.log("building "+this.type(),this.element,this.options),this.document=this.window.document,this.name=this.element.attr(Mercury.config.regions.identifier),this.history=new Mercury.HistoryBuffer,this.build(),this.bindEvents(),this.pushHistory(),this.element.data("region",this)}return t.prototype.type=function(){return"unknown"},t.prototype.build=function(){},t.prototype.focus=function(){},t.prototype.bindEvents=function(){var t=this;return Mercury.on("mode",function(e,i){return"preview"===i.mode?t.togglePreview():void 0}),Mercury.on("focus:frame",function(){return t.previewing||Mercury.region!==t?void 0:t.focus()}),Mercury.on("action",function(e,i){return t.previewing||Mercury.region!==t||e.isDefaultPrevented()?void 0:i.action?t.execCommand(i.action,i):void 0}),this.element.on("mousemove",function(e){var i;if(!t.previewing&&Mercury.region===t)return i=jQuery(e.target).closest("[data-snippet]"),i.length&&(t.snippet=i,t.snippet.data("snippet"))?Mercury.trigger("show:toolbar",{type:"snippet",snippet:t.snippet}):void 0}),this.element.on("mouseout",function(){return t.previewing?void 0:Mercury.trigger("hide:toolbar",{type:"snippet",immediately:!1})})},t.prototype.content=function(t,e){var i,n,s,r,o;if(null==t&&(t=null),null==e&&(e=!1),null!==t)return this.element.html(t);if(i=jQuery("<div>").appendTo(this.document.createDocumentFragment()),i.html(this.element.html().replace(/^\s+|\s+$/g,"")),e)for(o=i.find("[data-snippet]"),s=0,r=o.length;r>s;s++)n=o[s],n=jQuery(n),n.attr({contenteditable:null,"data-version":null}),n.html("["+n.data("snippet")+"]");return i.html()},t.prototype.togglePreview=function(){return this.previewing?(this.previewing=!1,this.element.attr(Mercury.config.regions.attribute,this.type()),Mercury.region===this?this.focus():void 0):(this.previewing=!0,this.element.removeAttr(Mercury.config.regions.attribute),Mercury.trigger("region:blurred",{region:this}))},t.prototype.execCommand=function(t,e){return null==e&&(e={}),this.focus(),"redo"!==t&&this.pushHistory(),Mercury.log("execCommand",t,e.value),Mercury.changes=!0},t.prototype.pushHistory=function(){return this.history.push(this.content())},t.prototype.snippets=function(){var t,e,i,n,s,r;for(i={},r=this.element.find("[data-snippet]"),n=0,s=r.length;s>n;n++)t=r[n],e=Mercury.Snippet.find(jQuery(t).data("snippet")),e&&(i[e.identity]=e.serialize());return i},t.prototype.dataAttributes=function(){var t,e,i,n,s;for(e={},s=Mercury.config.regions.dataAttributes,i=0,n=s.length;n>i;i++)t=s[i],e[t]=(this.container||this.element).attr("data-"+t);return e},t.prototype.serialize=function(){return{type:this.type(),data:this.dataAttributes(),value:this.content(null,!0),snippets:this.snippets()}},t}()}).call(this);