(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};this.Mercury.modal=function(t,e){var i;return null==e&&(e={}),i=new Mercury.Modal(t,e),i.show(),i},this.Mercury.Modal=function(){function e(e,i){this.url=e,this.options=null!=i?i:{},this.hide=t(this.hide,this)}return e.prototype.show=function(t,e){var i,n=this;return null==t&&(t=null),null==e&&(e=null),this.url=t||this.url,this.options=e||this.options,(i=this.options).minWidth||(i.minWidth=400),this.options.ujsHandling!==!1&&(this.options.ujsHandling=!0),Mercury.trigger("focus:window"),this.initializeModal(),this.visible?this.update():this.appear(),this.options.content?setTimeout(function(){return n.loadContent(n.options.content)},500):void 0},e.prototype.initializeModal=function(){return this.initialized?void 0:(this.build(),this.bindEvents(),this.initialized=!0)},e.prototype.build=function(){var t,e;return this.element=jQuery("<div>",{"class":"mercury-modal loading"}),this.element.html('<h1 class="mercury-modal-title"><span></span><a>&times;</a></h1>'),this.element.append('<div class="mercury-modal-content-container"><div class="mercury-modal-content"></div></div>'),this.overlay=jQuery("<div>",{"class":"mercury-modal-overlay"}),this.titleElement=this.element.find(".mercury-modal-title"),this.contentContainerElement=this.element.find(".mercury-modal-content-container"),this.contentElement=this.element.find(".mercury-modal-content"),this.element.appendTo(null!=(t=jQuery(this.options.appendTo).get(0))?t:"body"),this.overlay.appendTo(null!=(e=jQuery(this.options.appendTo).get(0))?e:"body")},e.prototype.bindEvents=function(){var t=this;return Mercury.on("refresh",function(){return t.resize(!0)}),Mercury.on("resize",function(){return t.position()}),this.overlay.on("click",function(){return t.options.allowHideUsingOverlay?t.hide():void 0}),this.titleElement.find("a").on("click",function(){return t.hide()}),this.options.ujsHandling&&this.element.on("ajax:beforeSend",function(e,i,n){return n.success=function(e){return t.loadContent(e)}}),jQuery(document).on("keydown",function(e){return 27===e.keyCode&&t.visible?t.hide():void 0})},e.prototype.appear=function(){var t=this;return this.showing=!0,this.position(),this.overlay.show(),this.overlay.animate({opacity:1},200,"easeInOutSine",function(){return t.element.css({top:-t.element.height()}),t.setTitle(),t.element.show(),t.element.animate({top:0},200,"easeInOutSine",function(){return t.visible=!0,t.showing=!1,t.load()})})},e.prototype.resize=function(t){var e,i,n,s,r=this;return n=t?"visible":"hidden",i=this.titleElement.outerHeight(),s=this.contentElement.outerWidth(),this.contentPane&&this.contentPane.css({height:"auto"}),this.contentElement.css({height:"auto",visibility:n,display:"block"}),e=this.contentElement.outerHeight()+i,this.options.minWidth>s&&(s=this.options.minWidth),(e>Mercury.displayRect.fullHeight||this.options.fullHeight)&&(e=Mercury.displayRect.fullHeight),this.element.stop().animate({left:(Mercury.displayRect.width-s)/2,width:s,height:e},200,"easeInOutSine",function(){var t;return r.contentElement.css({visibility:"visible",display:"block"}),r.contentPane.length?(r.contentElement.css({height:e-i,overflow:"visible"}),t=r.contentControl.length?r.contentControl.outerHeight()+10:0,r.contentPane.css({height:e-i-t-20}),r.contentPane.find(".mercury-display-pane").css({width:s-20})):r.contentElement.css({height:e-i,overflow:"auto"})})},e.prototype.position=function(){var t,e,i,n,s;return n=Mercury.displayRect.width,this.contentPane&&this.contentPane.css({height:"auto"}),this.contentElement.css({height:"auto"}),this.element.css({width:"auto",height:"auto",display:"block",visibility:"hidden"}),s=this.element.width(),e=this.element.height(),this.options.minWidth>s&&(s=this.options.minWidth),(e>Mercury.displayRect.fullHeight||this.options.fullHeight)&&(e=Mercury.displayRect.fullHeight),i=this.titleElement.outerHeight(),this.contentPane&&this.contentPane.length?(this.contentElement.css({height:e-i,overflow:"visible"}),t=this.contentControl.length?this.contentControl.outerHeight()+10:0,this.contentPane.css({height:e-i-t-20}),this.contentPane.find(".mercury-display-pane").css({width:s-20})):this.contentElement.css({height:e-i,overflow:"auto"}),this.element.css({left:(n-s)/2,width:s,height:e,display:this.visible?"block":"none",visibility:"visible"})},e.prototype.update=function(){return this.reset(),this.resize(),this.load()},e.prototype.load=function(){var t=this;return this.setTitle(),this.url?(this.element.addClass("loading"),Mercury.preloadedViews[this.url]?setTimeout(function(){return t.loadContent(Mercury.preloadedViews[t.url])},10):jQuery.ajax(this.url,{headers:Mercury.ajaxHeaders(),type:this.options.loadType||"GET",data:this.options.loadData,success:function(e){return t.loadContent(e)},error:function(){return t.hide(),Mercury.notify("Mercury was unable to load %s for the modal.",t.url)}})):void 0},e.prototype.loadContent=function(t,e){return null==e&&(e=null),this.initializeModal(),this.options=e||this.options,this.setTitle(),this.loaded=!0,this.element.removeClass("loading"),this.contentElement.html(t),this.contentElement.css({display:"none",visibility:"hidden"}),this.contentPane=this.element.find(".mercury-display-pane-container"),this.contentControl=this.element.find(".mercury-display-controls"),this.options.afterLoad&&this.options.afterLoad.call(this),this.options.handler&&(Mercury.modalHandlers[this.options.handler]?"function"==typeof Mercury.modalHandlers[this.options.handler]?Mercury.modalHandlers[this.options.handler].call(this):(jQuery.extend(this,Mercury.modalHandlers[this.options.handler]),this.initialize()):Mercury.lightviewHandlers[this.options.handler]&&("function"==typeof Mercury.lightviewHandlers[this.options.handler]?Mercury.lightviewHandlers[this.options.handler].call(this):(jQuery.extend(this,Mercury.lightviewHandlers[this.options.handler]),this.initialize()))),Mercury.config.localization.enabled&&this.element.localize(Mercury.locale()),this.element.find(".modal-close").on("click",this.hide),this.resize()},e.prototype.setTitle=function(){var t;return this.titleElement.find("span").html(Mercury.I18n(this.options.title)),t=this.titleElement.find("a"),this.options.closeButton===!1?t.hide():t.show()},e.prototype.serializeForm=function(){return this.element.find("form").serializeObject()||{}},e.prototype.reset=function(){return this.titleElement.find("span").html(""),this.contentElement.html("")},e.prototype.hide=function(){return this.showing?void 0:(this.options={},Mercury.trigger("focus:frame"),this.element.hide(),this.overlay.hide(),this.reset(),this.visible=!1)},e}()}).call(this);