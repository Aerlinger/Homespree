!function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};this.Mercury.modal=function(e,t){var i;return null==t&&(t={}),i=new Mercury.Modal(e,t),i.show(),i},this.Mercury.Modal=function(){function t(t,i){this.url=t,this.options=null!=i?i:{},this.hide=e(this.hide,this)}return t.prototype.show=function(e,t){var i,n=this;return null==e&&(e=null),null==t&&(t=null),this.url=e||this.url,this.options=t||this.options,(i=this.options).minWidth||(i.minWidth=400),this.options.ujsHandling!==!1&&(this.options.ujsHandling=!0),Mercury.trigger("focus:window"),this.initializeModal(),this.visible?this.update():this.appear(),this.options.content?setTimeout(function(){return n.loadContent(n.options.content)},500):void 0},t.prototype.initializeModal=function(){return this.initialized?void 0:(this.build(),this.bindEvents(),this.initialized=!0)},t.prototype.build=function(){var e,t;return this.element=jQuery("<div>",{"class":"mercury-modal loading"}),this.element.html('<h1 class="mercury-modal-title"><span></span><a>&times;</a></h1>'),this.element.append('<div class="mercury-modal-content-container"><div class="mercury-modal-content"></div></div>'),this.overlay=jQuery("<div>",{"class":"mercury-modal-overlay"}),this.titleElement=this.element.find(".mercury-modal-title"),this.contentContainerElement=this.element.find(".mercury-modal-content-container"),this.contentElement=this.element.find(".mercury-modal-content"),this.element.appendTo(null!=(e=jQuery(this.options.appendTo).get(0))?e:"body"),this.overlay.appendTo(null!=(t=jQuery(this.options.appendTo).get(0))?t:"body")},t.prototype.bindEvents=function(){var e=this;return Mercury.on("refresh",function(){return e.resize(!0)}),Mercury.on("resize",function(){return e.position()}),this.overlay.on("click",function(){return e.options.allowHideUsingOverlay?e.hide():void 0}),this.titleElement.find("a").on("click",function(){return e.hide()}),this.options.ujsHandling&&this.element.on("ajax:beforeSend",function(t,i,n){return n.success=function(t){return e.loadContent(t)}}),jQuery(document).on("keydown",function(t){return 27===t.keyCode&&e.visible?e.hide():void 0})},t.prototype.appear=function(){var e=this;return this.showing=!0,this.position(),this.overlay.show(),this.overlay.animate({opacity:1},200,"easeInOutSine",function(){return e.element.css({top:-e.element.height()}),e.setTitle(),e.element.show(),e.element.animate({top:0},200,"easeInOutSine",function(){return e.visible=!0,e.showing=!1,e.load()})})},t.prototype.resize=function(e){var t,i,n,r,s=this;return n=e?"visible":"hidden",i=this.titleElement.outerHeight(),r=this.contentElement.outerWidth(),this.contentPane&&this.contentPane.css({height:"auto"}),this.contentElement.css({height:"auto",visibility:n,display:"block"}),t=this.contentElement.outerHeight()+i,r<this.options.minWidth&&(r=this.options.minWidth),(t>Mercury.displayRect.fullHeight||this.options.fullHeight)&&(t=Mercury.displayRect.fullHeight),this.element.stop().animate({left:(Mercury.displayRect.width-r)/2,width:r,height:t},200,"easeInOutSine",function(){var e;return s.contentElement.css({visibility:"visible",display:"block"}),s.contentPane.length?(s.contentElement.css({height:t-i,overflow:"visible"}),e=s.contentControl.length?s.contentControl.outerHeight()+10:0,s.contentPane.css({height:t-i-e-20}),s.contentPane.find(".mercury-display-pane").css({width:r-20})):s.contentElement.css({height:t-i,overflow:"auto"})})},t.prototype.position=function(){var e,t,i,n,r;return n=Mercury.displayRect.width,this.contentPane&&this.contentPane.css({height:"auto"}),this.contentElement.css({height:"auto"}),this.element.css({width:"auto",height:"auto",display:"block",visibility:"hidden"}),r=this.element.width(),t=this.element.height(),r<this.options.minWidth&&(r=this.options.minWidth),(t>Mercury.displayRect.fullHeight||this.options.fullHeight)&&(t=Mercury.displayRect.fullHeight),i=this.titleElement.outerHeight(),this.contentPane&&this.contentPane.length?(this.contentElement.css({height:t-i,overflow:"visible"}),e=this.contentControl.length?this.contentControl.outerHeight()+10:0,this.contentPane.css({height:t-i-e-20}),this.contentPane.find(".mercury-display-pane").css({width:r-20})):this.contentElement.css({height:t-i,overflow:"auto"}),this.element.css({left:(n-r)/2,width:r,height:t,display:this.visible?"block":"none",visibility:"visible"})},t.prototype.update=function(){return this.reset(),this.resize(),this.load()},t.prototype.load=function(){var e=this;return this.setTitle(),this.url?(this.element.addClass("loading"),Mercury.preloadedViews[this.url]?setTimeout(function(){return e.loadContent(Mercury.preloadedViews[e.url])},10):jQuery.ajax(this.url,{headers:Mercury.ajaxHeaders(),type:this.options.loadType||"GET",data:this.options.loadData,success:function(t){return e.loadContent(t)},error:function(){return e.hide(),Mercury.notify("Mercury was unable to load %s for the modal.",e.url)}})):void 0},t.prototype.loadContent=function(e,t){return null==t&&(t=null),this.initializeModal(),this.options=t||this.options,this.setTitle(),this.loaded=!0,this.element.removeClass("loading"),this.contentElement.html(e),this.contentElement.css({display:"none",visibility:"hidden"}),this.contentPane=this.element.find(".mercury-display-pane-container"),this.contentControl=this.element.find(".mercury-display-controls"),this.options.afterLoad&&this.options.afterLoad.call(this),this.options.handler&&(Mercury.modalHandlers[this.options.handler]?"function"==typeof Mercury.modalHandlers[this.options.handler]?Mercury.modalHandlers[this.options.handler].call(this):(jQuery.extend(this,Mercury.modalHandlers[this.options.handler]),this.initialize()):Mercury.lightviewHandlers[this.options.handler]&&("function"==typeof Mercury.lightviewHandlers[this.options.handler]?Mercury.lightviewHandlers[this.options.handler].call(this):(jQuery.extend(this,Mercury.lightviewHandlers[this.options.handler]),this.initialize()))),Mercury.config.localization.enabled&&this.element.localize(Mercury.locale()),this.element.find(".modal-close").on("click",this.hide),this.resize()},t.prototype.setTitle=function(){var e;return this.titleElement.find("span").html(Mercury.I18n(this.options.title)),e=this.titleElement.find("a"),this.options.closeButton===!1?e.hide():e.show()},t.prototype.serializeForm=function(){return this.element.find("form").serializeObject()||{}},t.prototype.reset=function(){return this.titleElement.find("span").html(""),this.contentElement.html("")},t.prototype.hide=function(){return this.showing?void 0:(this.options={},Mercury.trigger("focus:frame"),this.element.hide(),this.overlay.hide(),this.reset(),this.visible=!1)},t}()}.call(this);