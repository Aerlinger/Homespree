!function(){var e={}.hasOwnProperty;this.Mercury.Snippet=function(){function t(e,t,i){this.name=e,this.identity=t,null==i&&(i={}),this.version=0,this.data="",this.wrapperTag="div",this.history=new Mercury.HistoryBuffer,this.setOptions(i)}return t.all=[],t.displayOptionsFor=function(e,t,i){var n;return null==t&&(t={}),null==i&&(i=!0),i?Mercury.modal(this.optionsUrl(e),jQuery.extend({title:"Snippet Options",handler:"insertSnippet",snippetName:e,loadType:Mercury.config.snippets.method},t)):(n=Mercury.Snippet.create(e),Mercury.trigger("action",{action:"insertSnippet",value:n})),Mercury.snippet=null},t.optionsUrl=function(e){var t;return t=Mercury.config.snippets.optionsUrl,"function"==typeof t&&(t=t()),t.replace(":name",e)},t.previewUrl=function(e){var t;return t=Mercury.config.snippets.previewUrl,"function"==typeof t&&(t=t()),t.replace(":name",e)},t.create=function(e,t){var i;return i=new Mercury.Snippet(e,this.uniqueId(),t),this.all.push(i),i},t.uniqueId=function(){var e,t,i,n,r;for(r=[0,"snippet_0"],e=r[0],i=r[1],t=function(){var e,t,i,r;for(i=this.all,r=[],e=0,t=i.length;t>e;e++)n=i[e],r.push(n.identity);return r}.call(this);-1!==t.indexOf(i);)e+=1,i="snippet_"+e;return i},t.find=function(e){var t,i,n,r;for(r=this.all,i=0,n=r.length;n>i;i++)if(t=r[i],t.identity===e)return t;return null},t.load=function(t){var i,n,r,s;s=[];for(n in t)e.call(t,n)&&(i=t[n],r=new Mercury.Snippet(i.name,n,i),s.push(this.all.push(r)));return s},t.clearAll=function(){return delete this.all,this.all=[]},t.prototype.getHTML=function(e,t){var i;return null==t&&(t=null),i=jQuery("<"+this.wrapperTag+">",{"class":""+this.name+"-snippet",contenteditable:"false","data-snippet":this.identity,"data-version":this.version},e),i.html("["+this.identity+"]"),this.loadPreview(i,t),i},t.prototype.getText=function(){return"[--"+this.identity+"--]"},t.prototype.loadPreview=function(e,i){var n=this;return null==i&&(i=null),jQuery.ajax(t.previewUrl(this.name),{headers:Mercury.ajaxHeaders(),type:Mercury.config.snippets.method,data:this.options,success:function(t){return n.data=t,e.html(t),i?i():void 0},error:function(){return Mercury.notify('Error loading the preview for the "%s" snippet.',n.name)}})},t.prototype.displayOptions=function(){return Mercury.snippet=this,Mercury.modal(t.optionsUrl(this.name),{title:"Snippet Options",handler:"insertSnippet",loadType:Mercury.config.snippets.method,loadData:this.options})},t.prototype.setOptions=function(e){return this.options=e,delete this.options.authenticity_token,delete this.options.utf8,this.options.wrapperTag&&(this.wrapperTag=this.options.wrapperTag),this.version+=1,this.history.push(this.options)},t.prototype.setVersion=function(e){return null==e&&(e=null),e=parseInt(e),e&&this.history.stack[e-1]?(this.version=e,this.options=this.history.stack[e-1],!0):!1},t.prototype.serialize=function(){return $.extend({name:this.name},this.options)},t}()}.call(this);