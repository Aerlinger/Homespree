(function(){var e={}.hasOwnProperty;this.Mercury.Snippet=function(){function t(e,t,n){this.name=e,this.identity=t,n==null&&(n={}),this.version=0,this.data="",this.wrapperTag="div",this.history=new Mercury.HistoryBuffer,this.setOptions(n)}return t.all=[],t.displayOptionsFor=function(e,t,n){var r;return t==null&&(t={}),n==null&&(n=!0),n?Mercury.modal(this.optionsUrl(e),jQuery.extend({title:"Snippet Options",handler:"insertSnippet",snippetName:e,loadType:Mercury.config.snippets.method},t)):(r=Mercury.Snippet.create(e),Mercury.trigger("action",{action:"insertSnippet",value:r})),Mercury.snippet=null},t.optionsUrl=function(e){var t;return t=Mercury.config.snippets.optionsUrl,typeof t=="function"&&(t=t()),t.replace(":name",e)},t.previewUrl=function(e){var t;return t=Mercury.config.snippets.previewUrl,typeof t=="function"&&(t=t()),t.replace(":name",e)},t.create=function(e,t){var n;return n=new Mercury.Snippet(e,this.uniqueId(),t),this.all.push(n),n},t.uniqueId=function(){var e,t,n,r,i;i=[0,"snippet_0"],e=i[0],n=i[1],t=function(){var e,t,n,i;n=this.all,i=[];for(e=0,t=n.length;e<t;e++)r=n[e],i.push(r.identity);return i}.call(this);while(t.indexOf(n)!==-1)e+=1,n="snippet_"+e;return n},t.find=function(e){var t,n,r,i;i=this.all;for(n=0,r=i.length;n<r;n++){t=i[n];if(t.identity===e)return t}return null},t.load=function(t){var n,r,i,s;s=[];for(r in t){if(!e.call(t,r))continue;n=t[r],i=new Mercury.Snippet(n.name,r,n),s.push(this.all.push(i))}return s},t.clearAll=function(){return delete this.all,this.all=[]},t.prototype.getHTML=function(e,t){var n;return t==null&&(t=null),n=jQuery("<"+this.wrapperTag+">",{"class":""+this.name+"-snippet",contenteditable:"false","data-snippet":this.identity,"data-version":this.version},e),n.html("["+this.identity+"]"),this.loadPreview(n,t),n},t.prototype.getText=function(e){return"[--"+this.identity+"--]"},t.prototype.loadPreview=function(e,n){var r=this;return n==null&&(n=null),jQuery.ajax(t.previewUrl(this.name),{headers:Mercury.ajaxHeaders(),type:Mercury.config.snippets.method,data:this.options,success:function(t){r.data=t,e.html(t);if(n)return n()},error:function(){return Mercury.notify('Error loading the preview for the "%s" snippet.',r.name)}})},t.prototype.displayOptions=function(){return Mercury.snippet=this,Mercury.modal(t.optionsUrl(this.name),{title:"Snippet Options",handler:"insertSnippet",loadType:Mercury.config.snippets.method,loadData:this.options})},t.prototype.setOptions=function(e){return this.options=e,delete this.options.authenticity_token,delete this.options.utf8,this.options.wrapperTag&&(this.wrapperTag=this.options.wrapperTag),this.version+=1,this.history.push(this.options)},t.prototype.setVersion=function(e){return e==null&&(e=null),e=parseInt(e),e&&this.history.stack[e-1]?(this.version=e,this.options=this.history.stack[e-1],!0):!1},t.prototype.serialize=function(){return $.extend({name:this.name},this.options)},t}()}).call(this);