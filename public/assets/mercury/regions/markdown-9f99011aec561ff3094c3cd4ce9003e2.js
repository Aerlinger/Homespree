(function(){var t={}.hasOwnProperty,e=function(e,i){function n(){this.constructor=e}for(var s in i)t.call(i,s)&&(e[s]=i[s]);return n.prototype=i.prototype,e.prototype=new n,e.__super__=i.prototype,e};this.Mercury.Regions.Markdown=function(t){function i(t,e,n){this.element=t,this.window=e,this.options=null!=n?n:{},i.__super__.constructor.apply(this,arguments),this.converter=new Showdown.converter}var n;return e(i,t),i.supported=document.getElementById,i.supportedText="Chrome 10+, Firefox 4+, IE 7+, Safari 5+, Opera 8+",n="markdown",i.prototype.type=function(){return n},i.prototype.build=function(){var t,e,i;return i="100%",t=this.element.height(),e=this.element.html().replace(/^\s+|\s+$/g,"").replace("&gt;",">"),this.textarea=jQuery("<textarea>",this.document).val(e).addClass("mercury-textarea"),this.textarea.css({border:0,background:"transparent",display:"block","overflow-y":"hidden",width:i,height:t,fontFamily:'"Courier New", Courier, monospace'}),this.element.empty().append(this.textarea),this.previewElement=jQuery("<div>",this.document),this.element.append(this.previewElement),this.container=this.element,this.container.data("region",this),this.element=this.textarea,this.resize()},i.prototype.dataAttributes=function(){var t,e,i,n,s;for(e={},s=Mercury.config.regions.dataAttributes,i=0,n=s.length;n>i;i++)t=s[i],e[t]=this.container.attr("data-"+t);return e},i.prototype.bindEvents=function(){var t=this;return Mercury.on("mode",function(e,i){return"preview"===i.mode?t.togglePreview():void 0}),Mercury.on("focus:frame",function(){return t.previewing||Mercury.region!==t?void 0:t.focus()}),Mercury.on("action",function(e,i){return t.previewing||Mercury.region!==t?void 0:i.action?t.execCommand(i.action,i):void 0}),Mercury.on("unfocus:regions",function(){return t.previewing||Mercury.region!==t?void 0:(t.element.blur(),t.container.removeClass("focus"),Mercury.trigger("region:blurred",{region:t}))}),this.element.on("dragenter",function(e){return t.previewing?void 0:(e.preventDefault(),e.originalEvent.dataTransfer.dropEffect="copy")}),this.element.on("dragover",function(e){return t.previewing?void 0:(e.preventDefault(),e.originalEvent.dataTransfer.dropEffect="copy")}),this.element.on("drop",function(e){return t.previewing?void 0:(Mercury.snippet&&(e.preventDefault(),t.focus(),Mercury.Snippet.displayOptionsFor(Mercury.snippet.name,{},Mercury.snippet.hasOptions)),e.originalEvent.dataTransfer.files.length?(e.preventDefault(),t.focus(),Mercury.uploader(e.originalEvent.dataTransfer.files[0])):void 0)}),this.element.on("focus",function(){return t.previewing?void 0:(Mercury.region=t,t.container.addClass("focus"),Mercury.trigger("region:focused",{region:t}))}),this.element.on("keydown",function(e){var i,n,s,r,o,a;if(!t.previewing){switch(t.resize(),e.keyCode){case 90:if(!e.metaKey)return;return e.preventDefault(),e.shiftKey?t.execCommand("redo"):t.execCommand("undo"),void 0;case 13:r=t.selection(),a=t.element.val(),o=a.lastIndexOf("\n",r.start),i=a.indexOf("\n",r.end),o>i&&(i=a.length),"\n"===a[o]&&(o=a.lastIndexOf("\n",r.start-1)),"-"===a[o+1]&&(r.replace("\n- ",!1,!0),e.preventDefault()),/\d/.test(a[o+1])&&(n=a.substring(o,i),/(\d+)\./.test(n)&&(s=parseInt(RegExp.$1),r.replace("\n"+(s+=1)+". ",!1,!0),e.preventDefault()));break;case 9:e.preventDefault(),t.execCommand("insertHTML",{value:"  "})}if(e.metaKey)switch(e.keyCode){case 66:t.execCommand("bold"),e.preventDefault();break;case 73:t.execCommand("italic"),e.preventDefault();break;case 85:t.execCommand("underline"),e.preventDefault()}return t.pushHistory(e.keyCode)}}),this.element.on("keyup",function(){return t.previewing?void 0:(Mercury.changes=!0,t.resize(),Mercury.trigger("region:update",{region:t}))}),this.element.on("mouseup",function(){return t.previewing?void 0:(t.focus(),Mercury.trigger("region:focused",{region:t}))}),this.previewElement.on("click",function(e){return t.previewing?$(e.target).closest("a").attr("target","_parent"):void 0})},i.prototype.focus=function(){return this.element.focus()},i.prototype.content=function(t,e){return null==t&&(t=null),null==e&&(e=!0),null!==t?"string"===jQuery.type(t)?this.element.val(t):(this.element.val(t.html),this.selection().select(t.selection.start,t.selection.end)):this.element.val()},i.prototype.contentAndSelection=function(){return{html:this.content(null,!1),selection:this.selection().serialize()}},i.prototype.togglePreview=function(){var t;return this.previewing?(this.previewing=!1,this.container.attr(Mercury.config.regions.attribute,n),this.previewElement.hide(),this.element.show(),Mercury.region===this?this.focus():void 0):(this.previewing=!0,this.container.removeAttr(Mercury.config.regions.attribute),t=this.converter.makeHtml(this.element.val()),this.previewElement.html(t),this.previewElement.show(),this.element.hide(),Mercury.trigger("region:blurred",{region:this}))},i.prototype.execCommand=function(t,e){var n;return null==e&&(e={}),i.__super__.execCommand.apply(this,arguments),(n=Mercury.Regions.Markdown.actions[t])&&n.call(this,this.selection(),e),this.resize()},i.prototype.pushHistory=function(t){var e,i,n,s=this;return e=[13,46,8],n=2.5,t&&(i=e.indexOf(t)),clearTimeout(this.historyTimeout),i>=0&&i!==this.lastKnownKeyCode?this.history.push(this.contentAndSelection()):t?this.historyTimeout=setTimeout(function(){return s.history.push(s.contentAndSelection())},1e3*n):this.history.push(this.contentAndSelection()),this.lastKnownKeyCode=i},i.prototype.selection=function(){return new Mercury.Regions.Markdown.Selection(this.element)},i.prototype.resize=function(){return this.element.css({height:this.element.get(0).scrollHeight-100}),this.element.css({height:this.element.get(0).scrollHeight})},i.prototype.snippets=function(){},i.actions={undo:function(){return this.content(this.history.undo())},redo:function(){return this.content(this.history.redo())},insertHTML:function(t,e){var i;return e.value.get&&(i=e.value.get(0))&&(e.value=jQuery("<div>").html(i).html()),t.replace(e.value,!1,!0)},insertImage:function(t,e){return t.replace("![add alt text]("+encodeURI(e.value.src)+")",!0)},insertTable:function(t,e){return t.replace(e.value.replace(/<br>|<br\/>/gi,""),!1,!0)},insertLink:function(t,e){return t.replace("["+e.value.content+"]("+e.value.attrs.href+" 'optional title')",!0)},insertUnorderedList:function(t){return t.addList("unordered")},insertOrderedList:function(t){return t.addList("ordered")},style:function(t,e){return t.wrap('<span class="'+e.value+'">',"</span>")},formatblock:function(t,e){var i,n,s;s={h1:["# "," #"],h2:["## "," ##"],h3:["### "," ###"],h4:["#### "," ####"],h5:["##### "," #####"],h6:["###### "," ######"],pre:["    ",""],blockquote:["> ",""],p:["\n","\n"]};for(n in s)i=s[n],t.unWrapLine(""+i[0],""+i[1]);return"blockquote"===e.value?(Mercury.Regions.Markdown.actions.indent.call(this,t,e),void 0):t.wrapLine(""+s[e.value][0],""+s[e.value][1])},bold:function(t){return t.wrap("**","**")},italic:function(t){return t.wrap("_","_")},subscript:function(t){return t.wrap("<sub>","</sub>")},superscript:function(t){return t.wrap("<sup>","</sup>")},indent:function(t){return t.wrapLine("> ","",!1,!0)},outdent:function(t){return t.unWrapLine("> ","",!1,!0)},horizontalRule:function(t){return t.replace("\n- - -\n")},insertSnippet:function(t,e){var i;return i=e.value,t.replace(i.getText())}},i}(Mercury.Region),Mercury.Regions.Markdown.Selection=function(){function t(t){this.element=t,this.el=this.element.get(0),this.getDetails()}return t.prototype.serialize=function(){return{start:this.start,end:this.end}},t.prototype.getDetails=function(){return this.length=this.el.selectionEnd-this.el.selectionStart,this.start=this.el.selectionStart,this.end=this.el.selectionEnd,this.text=this.element.val().substr(this.start,this.length)},t.prototype.replace=function(t,e,i){var n,s,r;return null==e&&(e=!1),null==i&&(i=!1),this.getDetails(),r=this.element.val(),s=this.element.val(),this.element.val(r.substr(0,this.start)+t+r.substr(this.end,r.length)),n=this.element.val()!==s,e&&this.select(this.start,this.start+t.length),i&&this.select(this.start+t.length,this.start+t.length),n},t.prototype.select=function(t,e){return this.start=t,this.end=e,this.element.focus(),this.el.selectionStart=this.start,this.el.selectionEnd=this.end,this.getDetails()},t.prototype.wrap=function(t,e){return this.getDetails(),this.deselectNewLines(),this.replace(t+this.text+e,""!==this.text),""===this.text?this.select(this.start+t.length,this.start+t.length):void 0},t.prototype.wrapLine=function(t,e,i,n){var s,r,o,a;return null==i&&(i=!0),null==n&&(n=!1),this.getDetails(),r=this.serialize(),a=this.element.val(),o=a.lastIndexOf("\n",this.start),s=a.indexOf("\n",this.end),o>s&&(s=a.length),"\n"===a[o]&&(o=a.lastIndexOf("\n",this.start-1)),this.select(o+1,s),this.replace(t+this.text+e,i),n?this.select(r.start+t.length,r.end+t.length):void 0},t.prototype.unWrapLine=function(t,e,i,n){var s,r,o,a,l,c,u;return null==i&&(i=!0),null==n&&(n=!1),this.getDetails(),l=this.serialize(),u=this.element.val(),c=u.lastIndexOf("\n",this.start),r=u.indexOf("\n",this.end),c>r&&(r=u.length),"\n"===u[c]&&(c=u.lastIndexOf("\n",this.start-1)),this.select(c+1,r),window.something=this.text,o=new RegExp("^"+t.regExpEscape()),a=new RegExp(""+e.regExpEscape()+"$"),s=this.replace(this.text.replace(o,"").replace(a,""),i),n&&s?this.select(l.start-t.length,l.end-t.length):void 0},t.prototype.addList=function(t){var e,i,n,s,r,o;return o=this.element.val(),r=o.lastIndexOf("\n",this.start),e=o.indexOf("\n",this.end),r>e&&(e=o.length),"\n"===o[r]&&(r=o.lastIndexOf("\n",this.start-1)),this.select(r+1,e),s=this.text.split("\n"),"unordered"===t?this.replace("- "+s.join("\n- "),!0):this.replace(function(){var t,e,r;for(r=[],i=t=0,e=s.length;e>t;i=++t)n=s[i],r.push(""+(i+1)+". "+n);return r}().join("\n"),!0)},t.prototype.deselectNewLines=function(){var t,e;return e=this.text,t=e.replace(/\n+$/g,"").length,this.select(this.start,this.start+t)},t.prototype.placeMarker=function(){return this.wrap("[mercury-marker]","[mercury-marker]")},t.prototype.removeMarker=function(){var t,e,i;return i=this.element.val(),e=i.indexOf("[mercury-marker]"),e>-1?(t=i.indexOf("[mercury-marker]",e+1)-"[mercury-marker]".length,this.element.val(this.element.val().replace(/\[mercury-marker\]/g,"")),this.select(e,t)):void 0},t.prototype.textContent=function(){return this.text},t}()}).call(this);