(function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};this.Mercury.Regions.Simple=function(e){function r(e,t,i){this.element=e,this.window=t,this.options=i!=null?i:{},Mercury.log("building "+n,this.element,this.options),r.__super__.constructor.apply(this,arguments)}var n;return t(r,e),r.supported=document.getElementById,r.supportedText="Chrome 10+, Firefox 4+, IE 7+, Safari 5+, Opera 8+",n="simple",r.prototype.type=function(){return n},r.prototype.build=function(){var e,t,n;return this.element.css("display")==="block"?(n="100%",e=this.element.height()):(n=this.element.width(),e=this.element.height()),t=this.element.text(),this.textarea=jQuery("<textarea>",this.document).val(t).addClass("mercury-textarea"),this.textarea.css({border:0,background:"transparent","overflow-y":"hidden",width:n,height:e,fontFamily:"inherit",fontSize:"inherit",fontWeight:"inherit",fontStyle:"inherit",color:"inherit","min-height":0,padding:"0",margin:0,"border-radius":0,display:"inherit",lineHeight:"inherit",textAlign:"inherit"}),this.element.empty().append(this.textarea),this.container=this.element,this.container.data("region",this),this.element=this.textarea,this.resize()},r.prototype.bindEvents=function(){var e=this;return Mercury.on("mode",function(t,n){if(n.mode==="preview")return e.togglePreview()}),Mercury.on("focus:frame",function(){if(!e.previewing&&Mercury.region===e)return e.focus()}),Mercury.on("action",function(t,n){if(e.previewing||Mercury.region!==e)return;if(n.action)return e.execCommand(n.action,n)}),Mercury.on("unfocus:regions",function(){if(e.previewing||Mercury.region!==e)return;return e.element.blur(),e.container.removeClass("focus"),Mercury.trigger("region:blurred",{region:e})}),this.bindElementEvents()},r.prototype.bindElementEvents=function(){var e=this;return this.element.on("focus",function(){if(e.previewing)return;return Mercury.region=e,e.container.addClass("focus"),Mercury.trigger("region:focused",{region:e})}),this.element.on("keydown",function(t){var n,r,i,s,o,u;if(e.previewing)return;e.resize();switch(t.keyCode){case 90:if(!t.metaKey)return;t.preventDefault(),t.shiftKey?e.execCommand("redo"):e.execCommand("undo");return;case 13:s=e.selection(),u=e.element.val(),o=u.lastIndexOf("\n",s.start),n=u.indexOf("\n",s.end),n<o&&(n=u.length),u[o]==="\n"&&(o=u.lastIndexOf("\n",s.start-1)),u[o+1]==="-"&&s.replace("\n- ",!1,!0),/\d/.test(u[o+1])&&(r=u.substring(o,n),/(\d+)\./.test(r)&&(i=parseInt(RegExp.$1),s.replace("\n"+(i+=1)+". ",!1,!0))),t.preventDefault();break;case 9:t.preventDefault(),e.execCommand("insertHTML",{value:"  "})}return e.pushHistory(t.keyCode)}),this.element.on("keyup",function(){if(e.previewing)return;return Mercury.changes=!0,e.resize(),Mercury.trigger("region:update",{region:e})}),this.element.on("mouseup",function(){if(e.previewing)return;return e.focus(),Mercury.trigger("region:focused",{region:e})}),this.element.on("paste",function(t){if(e.previewing||Mercury.region!==e)return;if(e.specialContainer){t.preventDefault();return}if(e.pasting)return;return Mercury.changes=!0,e.handlePaste(t.originalEvent)})},r.prototype.handlePaste=function(e){this.execCommand("insertHTML",{value:e.clipboardData.getData("text/plain").replace(/\n/g," ")}),e.preventDefault()},r.prototype.path=function(){return[this.container.get(0)]},r.prototype.focus=function(){return this.element.focus()},r.prototype.content=function(e,t){return e==null&&(e=null),t==null&&(t=!0),e!==null?jQuery.type(e)==="string"?this.element.val(e):(this.element.val(e.html),this.selection().select(e.selection.start,e.selection.end)):this.element.val()},r.prototype.contentAndSelection=function(){return{html:this.content(null,!1),selection:this.selection().serialize()}},r.prototype.togglePreview=function(){var e;if(!this.previewing)return this.previewing=!0,e=jQuery("<div></div>").text(this.element.val()).html(),this.container.removeAttr(Mercury.config.regions.attribute),this.container.html(e),Mercury.trigger("region:blurred",{region:this});this.previewing=!1,this.element=this.container,this.container.attr(Mercury.config.regions.attribute,n),this.build(),this.bindElementEvents();if(Mercury.region===this)return this.focus()},r.prototype.execCommand=function(e,t){var n;return t==null&&(t={}),r.__super__.execCommand.apply(this,arguments),(n=Mercury.Regions.Simple.actions[e])&&n.call(this,this.selection(),t),this.resize()},r.prototype.pushHistory=function(e){var t,n,r,i=this;return t=[13,46,8],r=2.5,e&&(n=t.indexOf(e)),clearTimeout(this.historyTimeout),n>=0&&n!==this.lastKnownKeyCode?this.history.push(this.contentAndSelection()):e?this.historyTimeout=setTimeout(function(){return i.history.push(i.contentAndSelection())},r*1e3):this.history.push(this.contentAndSelection()),this.lastKnownKeyCode=n},r.prototype.selection=function(){return new Mercury.Regions.Simple.Selection(this.element)},r.prototype.resize=function(){return this.element.css({height:this.element.get(0).scrollHeight-100}),this.element.css({height:this.element.get(0).scrollHeight})},r.prototype.snippets=function(){},r.actions={undo:function(){return this.content(this.history.undo())},redo:function(){return this.content(this.history.redo())},insertHTML:function(e,t){var n;return t.value.get&&(n=t.value.get(0))&&(t.value=jQuery("<div>").html(n).html()),e.replace(t.value,!1,!0)}},r}(Mercury.Region),Mercury.Regions.Simple.Selection=function(){function e(e){this.element=e,this.el=this.element.get(0),this.getDetails()}return e.prototype.serialize=function(){return{start:this.start,end:this.end}},e.prototype.getDetails=function(){return this.length=this.el.selectionEnd-this.el.selectionStart,this.start=this.el.selectionStart,this.end=this.el.selectionEnd,this.text=this.element.val().substr(this.start,this.length)},e.prototype.replace=function(e,t,n){var r,i,s;return t==null&&(t=!1),n==null&&(n=!1),this.getDetails(),s=this.element.val(),i=this.element.val(),this.element.val(s.substr(0,this.start)+e+s.substr(this.end,s.length)),r=this.element.val()!==i,t&&this.select(this.start,this.start+e.length),n&&this.select(this.start+e.length,this.start+e.length),r},e.prototype.select=function(e,t){return this.start=e,this.end=t,this.element.focus(),this.el.selectionStart=this.start,this.el.selectionEnd=this.end,this.getDetails()},e.prototype.wrap=function(e,t){this.getDetails(),this.deselectNewLines(),this.replace(e+this.text+t,this.text!=="");if(this.text==="")return this.select(this.start+e.length,this.start+e.length)},e.prototype.deselectNewLines=function(){var e,t;return t=this.text,e=t.replace(/\n+$/g,"").length,this.select(this.start,this.start+e)},e.prototype.placeMarker=function(){return this.wrap("[mercury-marker]","[mercury-marker]")},e.prototype.removeMarker=function(){var e,t,n;n=this.element.val(),t=n.indexOf("[mercury-marker]");if(t>-1)return e=n.indexOf("[mercury-marker]",t+1)-"[mercury-marker]".length,this.element.val(this.element.val().replace(/\[mercury-marker\]/g,"")),this.select(t,e);return},e.prototype.textContent=function(){return this.text},e}()}).call(this);