(function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};this.Mercury.Regions.Snippets=function(e){function r(e,t,i){this.element=e,this.window=t,this.options=i!=null?i:{},Mercury.log("building "+n,this.element,this.options),r.__super__.constructor.apply(this,arguments),this.makeSortable()}var n;return t(r,e),r.supported=document.getElementById,r.supportedText="Chrome 10+, Firefox 4+, IE 7+, Safari 5+, Opera 8+",n="snippets",r.prototype.type=function(){return n},r.prototype.build=function(){var e,t,n,r;r=this.element.find("[data-snippet]");for(t=0,n=r.length;t<n;t++)e=r[t],jQuery(e).attr("data-version",0);if(this.element.css("minHeight")==="0px")return this.element.css({minHeight:20})},r.prototype.bindEvents=function(){var e=this;return r.__super__.bindEvents.apply(this,arguments),Mercury.on("unfocus:regions",function(t){if(e.previewing)return;if(Mercury.region===e)return e.element.removeClass("focus"),e.element.sortable("destroy"),Mercury.trigger("region:blurred",{region:e})}),Mercury.on("focus:window",function(t){if(e.previewing)return;if(Mercury.region===e)return e.element.removeClass("focus"),e.element.sortable("destroy"),Mercury.trigger("region:blurred",{region:e})}),this.element.on("mouseup",function(){if(e.previewing)return;return e.focus(),Mercury.trigger("region:focused",{region:e})}),this.element.on("dragover",function(t){if(e.previewing)return;return t.preventDefault(),t.originalEvent.dataTransfer.dropEffect="copy"}),this.element.on("drop",function(t){if(e.previewing||!Mercury.snippet)return;return e.focus(),t.preventDefault(),Mercury.Snippet.displayOptionsFor(Mercury.snippet.name,{},Mercury.snippet.hasOptions)}),jQuery(this.document).on("keydown",function(t){if(e.previewing||Mercury.region!==e)return;switch(t.keyCode){case 90:if(!t.metaKey)return;return t.preventDefault(),t.shiftKey?e.execCommand("redo"):e.execCommand("undo")}}),jQuery(this.document).on("keyup",function(){if(e.previewing||Mercury.region!==e)return;return Mercury.changes=!0})},r.prototype.focus=function(){return Mercury.region=this,this.makeSortable(),this.element.addClass("focus")},r.prototype.togglePreview=function(){return this.previewing?this.makeSortable():(this.element.sortable("destroy"),this.element.removeClass("focus")),r.__super__.togglePreview.apply(this,arguments)},r.prototype.execCommand=function(e,t){var n;t==null&&(t={}),r.__super__.execCommand.apply(this,arguments);if(n=Mercury.Regions.Snippets.actions[e])return n.call(this,t)},r.prototype.makeSortable=function(){var e=this;return this.element.sortable("destroy").sortable({document:this.document,scroll:!1,containment:"parent",items:"[data-snippet]",opacity:.4,revert:100,tolerance:"pointer",beforeStop:function(){return Mercury.trigger("hide:toolbar",{type:"snippet",immediately:!0}),!0},stop:function(){return setTimeout(function(){return e.pushHistory()},100),!0}})},r.actions={undo:function(){return this.content(this.history.undo())},redo:function(){return this.content(this.history.redo())},insertSnippet:function(e){var t,n,r=this;return n=e.value,(t=this.element.find("[data-snippet="+n.identity+"]")).length?t.replaceWith(n.getHTML(this.document,function(){return r.pushHistory()})):this.element.append(n.getHTML(this.document,function(){return r.pushHistory()}))},editSnippet:function(){var e;if(!this.snippet)return;return e=Mercury.Snippet.find(this.snippet.data("snippet")),e.displayOptions()},removeSnippet:function(){return this.snippet&&this.snippet.remove(),Mercury.trigger("hide:toolbar",{type:"snippet",immediately:!0})}},r}(Mercury.Region)}).call(this);