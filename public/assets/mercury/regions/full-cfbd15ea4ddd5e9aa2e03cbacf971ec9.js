(function(){var t={}.hasOwnProperty,e=function(e,i){function n(){this.constructor=e}for(var s in i)t.call(i,s)&&(e[s]=i[s]);return n.prototype=i.prototype,e.prototype=new n,e.__super__=i.prototype,e},i=[].indexOf||function(t){for(var e=0,i=this.length;i>e;e++)if(e in this&&this[e]===t)return e;return-1};this.Mercury.Regions.Full=function(t){function n(t,e,i){this.element=t,this.window=e,this.options=null!=i?i:{},n.__super__.constructor.apply(this,arguments)}var s;return e(n,t),n.supported=document.designMode&&!jQuery.browser.konqueror&&!jQuery.browser.msie,n.supportedText="Chrome 10+, Firefox 4+, Safari 5+, Opera 11.64+",s="full",n.prototype.type=function(){return s},n.prototype.build=function(){var t,e,i,n,s;for(jQuery.browser.mozilla&&""===this.content()&&this.content("&nbsp;"),this.element.data({originalOverflow:this.element.css("overflow")}),this.element.css({overflow:"auto"}),this.specialContainer=jQuery.browser.mozilla&&"DIV"!==this.element.get(0).tagName,this.element.get(0).contentEditable=!0,s=this.element.find("[data-snippet]"),i=0,n=s.length;n>i;i++)e=s[i],e.contentEditable=!1,jQuery(e).attr("data-version","1");if(!this.document.mercuryEditing){this.document.mercuryEditing=!0;try{return this.document.execCommand("styleWithCSS",!1,!1),this.document.execCommand("insertBROnReturn",!1,!0),this.document.execCommand("enableInlineTableEditing",!1,!1),this.document.execCommand("enableObjectResizing",!1,!1)}catch(r){t=r}}},n.prototype.bindEvents=function(){var t=this;return n.__super__.bindEvents.apply(this,arguments),Mercury.on("region:update",function(){var e,i,n;if(!t.previewing&&Mercury.region===t)return setTimeout(function(){return t.selection().forceSelection(t.element.get(0))},1),i=t.currentElement(),i.length?(n=i.closest("table",t.element),n.length&&Mercury.tableEditor(n,i.closest("tr, td"),"<br/>"),e=i.closest("a",t.element),e.length&&e.attr("href")?Mercury.tooltip(e,'<a href="'+e.attr("href")+'" target="_blank">'+e.attr("href")+"</a>",{position:"below"}):Mercury.tooltip.hide()):void 0}),this.element.on("dragenter",function(e){return t.previewing?void 0:(Mercury.snippet||e.preventDefault(),e.originalEvent.dataTransfer.dropEffect="copy")}),this.element.on("dragover",function(e){return t.previewing?void 0:(Mercury.snippet||e.preventDefault(),e.originalEvent.dataTransfer.dropEffect="copy",jQuery.browser.webkit?(clearTimeout(t.dropTimeout),t.dropTimeout=setTimeout(function(){return t.element.trigger("possible:drop")},10)):void 0)}),this.element.on("drop",function(e){return!t.previewing&&(clearTimeout(t.dropTimeout),t.dropTimeout=setTimeout(function(){return t.element.trigger("possible:drop")},1),e.originalEvent.dataTransfer.files.length)?(e.preventDefault(),t.focus(),Mercury.uploader(e.originalEvent.dataTransfer.files[0])):void 0}),this.element.on("possible:drop",function(){var e;if(!t.previewing)return(e=t.element.find("img[data-snippet]").get(0))?(t.focus(),Mercury.Snippet.displayOptionsFor(jQuery(e).data("snippet"),{},jQuery(e).data("options")),t.document.execCommand("undo",!1,null)):void 0}),this.element.on("paste",function(e){if(!t.previewing&&Mercury.region===t){if(t.specialContainer)return e.preventDefault(),void 0;if(!t.pasting)return Mercury.changes=!0,t.handlePaste(e.originalEvent)}}),this.element.on("focus",function(){return t.previewing?void 0:(Mercury.region=t,setTimeout(function(){return t.selection().forceSelection(t.element.get(0))},1),Mercury.trigger("region:focused",{region:t}))}),this.element.on("blur",function(){return t.previewing?void 0:(Mercury.trigger("region:blurred",{region:t}),Mercury.tooltip.hide())}),this.element.on("click",function(e){return t.previewing?jQuery(e.target).closest("a").attr("target","_parent"):void 0}),this.element.on("dblclick",function(e){var i;if(!t.previewing)return i=jQuery(e.target).closest("img",t.element),i.length?(t.selection().selectNode(i.get(0),!0),Mercury.trigger("button",{action:"insertMedia"})):void 0}),this.element.on("mouseup",function(){return t.previewing?void 0:(t.pushHistory(),Mercury.trigger("region:update",{region:t}))}),this.element.on("keydown",function(e){var i;if(!t.previewing){switch(e.keyCode){case 90:if(!e.metaKey)return;return e.preventDefault(),e.shiftKey?t.execCommand("redo"):t.execCommand("undo"),void 0;case 13:jQuery.browser.webkit&&0===t.selection().commonAncestor().closest("li, ul, ol",t.element).length?(e.preventDefault(),t.document.execCommand("insertParagraph",!1,null)):(t.specialContainer||jQuery.browser.opera)&&(e.preventDefault(),t.document.execCommand("insertHTML",!1,"<br/>"));break;case 9:e.preventDefault(),i=t.selection().commonAncestor(),i.closest("li",t.element).length?e.shiftKey?i.parents("ul, ol").length>1&&t.execCommand("outdent"):t.execCommand("indent"):t.execCommand("insertHTML",{value:"&nbsp;&nbsp;"})}if(e.metaKey)switch(e.keyCode){case 66:t.execCommand("bold"),e.preventDefault();break;case 73:t.execCommand("italic"),e.preventDefault();break;case 85:t.execCommand("underline"),e.preventDefault()}return t.pushHistory(e.keyCode)}}),this.element.on("keyup",function(){return t.previewing?void 0:(Mercury.trigger("region:update",{region:t}),Mercury.changes=!0)})},n.prototype.focus=function(){var t,e=this;if(Mercury.region!==this){setTimeout(function(){return e.element.focus()},10);try{this.selection().selection.collapseToStart()}catch(i){t=i}}else setTimeout(function(){return e.element.focus()},10);return Mercury.trigger("region:focused",{region:this}),Mercury.trigger("region:update",{region:this})},n.prototype.content=function(t,e,i){var n,s,r,o,a,l,c,u,h,d,p,f,m,g;if(null==t&&(t=null),null==e&&(e=!0),null==i&&(i=!1),null!==t){for(n=jQuery("<div>").appendTo(this.document.createDocumentFragment()),n.html(t),m=n.find("[data-snippet]"),h=0,p=m.length;p>h;h++)if(r=m[h],r.contentEditable=!1,r=jQuery(r),c=Mercury.Snippet.find(r.data("snippet")))if(r.data("version"))c.setVersion(r.data("version"));else try{u=parseInt(r.html().match(/\/(\d+)\]/)[1]),u&&(c.setVersion(u),r.attr({"data-version":u}),r.html(c.data))}catch(v){o=v}return this.element.html(n.html()),this.selection().selectMarker(this.element)}if(this.element.find("meta").remove(),i&&(l=this.selection(),l.placeMarker()),n=jQuery("<div>").appendTo(this.document.createDocumentFragment()),n.html(this.element.html().replace(/^\s+|\s+$/g,"")),e)for(g=n.find("[data-snippet]"),a=d=0,f=g.length;f>d;a=++d)r=g[a],r=jQuery(r),(c=Mercury.Snippet.find(r.data("snippet")))&&(c.data=r.html()),r.html("["+r.data("snippet")+"/"+r.data("version")+"]"),r.attr({contenteditable:null,"data-version":null});return s=n.html(),i&&l.removeMarker(),s},n.prototype.togglePreview=function(){return this.previewing?(this.element.get(0).contentEditable=!0,this.element.css({overflow:"auto"})):(this.content(this.content()),this.element.get(0).contentEditable=!1,this.element.css({overflow:this.element.data("originalOverflow")}),this.element.blur()),n.__super__.togglePreview.apply(this,arguments)},n.prototype.execCommand=function(t,e){var i,s,r;if(null==e&&(e={}),n.__super__.execCommand.apply(this,arguments),s=Mercury.config.behaviors[t]||Mercury.Regions.Full.actions[t])s.call(this,this.selection(),e);else{"indent"===t&&(r=this.element.get(0).previousSibling),"insertHTML"===t&&e.value&&e.value.get&&(e.value=jQuery("<div>").html(e.value).html());try{this.document.execCommand(t,!1,e.value)}catch(o){i=o,"indent"===t&&this.element.prev()!==r&&this.element.prev().remove()}}return this.element.find("img").one("error",function(){return jQuery(this).attr({src:"/assets/mercury/missing-image.png",title:"Image not found"})})},n.prototype.pushHistory=function(t){var e,i,n,s=this;return e=[13,46,8],n=2.5,t&&(i=e.indexOf(t)),clearTimeout(this.historyTimeout),i>=0&&i!==this.lastKnownKeyCode?this.history.push(this.content(null,!1,!0)):t?this.historyTimeout=setTimeout(function(){return s.history.push(s.content(null,!1,!0))},1e3*n):this.history.push(this.content(null,!1,!0)),this.lastKnownKeyCode=i},n.prototype.selection=function(){return new Mercury.Regions.Full.Selection(this.window.getSelection(),this.document)},n.prototype.path=function(){var t;return t=this.selection().commonAncestor(),t?t.get(0)===this.element.get(0)?[]:t.parentsUntil(this.element):[]},n.prototype.currentElement=function(){var t,e;return t=[],e=this.selection(),e.range&&(t=e.commonAncestor(),3===t.get(0).nodeType&&(t=t.parent())),t},n.prototype.handlePaste=function(t){var e,i,n=this;return"text"===Mercury.config.pasting.sanitize&&t.clipboardData?(this.execCommand("insertHTML",{value:t.clipboardData.getData("text/plain")}),t.preventDefault(),void 0):(i=this.selection(),i.placeMarker(),e=jQuery("#mercury_sanitizer",this.document).focus(),setTimeout(function(){var t;return t=n.sanitize(e),i.selectMarker(n.element),i.removeMarker(),n.element.focus(),n.execCommand("insertHTML",{value:t})},1))},n.prototype.sanitize=function(t){var e,n,s,r,o,a,l,c,u,h,d,p,f,m;if(t.find("["+Mercury.config.regions.attribute+"]").remove(),t.find('[src*="webkit-fake-url://"]').remove(),Mercury.config.pasting.sanitize)switch(Mercury.config.pasting.sanitize){case"blacklist":t.find("[style]").removeAttr("style"),t.find('[class="Apple-style-span"]').removeClass("Apple-style-span"),o=t.html();break;case"whitelist":for(d=t.find("*"),l=0,u=d.length;u>l;l++){a=d[l],e=!1,p=Mercury.config.pasting.whitelist;for(s in p)if(n=p[s],a.tagName.toLowerCase()===s.toLowerCase()){for(e=!0,f=jQuery(a.attributes),c=0,h=f.length;h>c;c++)r=f[c],m=r.name,0>i.call(n,m)&&jQuery(a).removeAttr(r.name);break}e||jQuery(a).replaceWith(jQuery(a).contents())}o=t.html();break;default:o=t.text()}else o=t.html(),(o.indexOf("<!--StartFragment-->")>-1||o.indexOf('="mso-')>-1||o.indexOf("<o:")>-1||o.indexOf('="Mso')>-1)&&(o=t.text());return t.html(""),o},n.actions={insertRowBefore:function(){return Mercury.tableEditor.addRow("before")},insertRowAfter:function(){return Mercury.tableEditor.addRow("after")},insertColumnBefore:function(){return Mercury.tableEditor.addColumn("before")},insertColumnAfter:function(){return Mercury.tableEditor.addColumn("after")},deleteColumn:function(){return Mercury.tableEditor.removeColumn()},deleteRow:function(){return Mercury.tableEditor.removeRow()},increaseColspan:function(){return Mercury.tableEditor.increaseColspan()},decreaseColspan:function(){return Mercury.tableEditor.decreaseColspan()},increaseRowspan:function(){return Mercury.tableEditor.increaseRowspan()},decreaseRowspan:function(){return Mercury.tableEditor.decreaseRowspan()},undo:function(){return this.content(this.history.undo())},redo:function(){return this.content(this.history.redo())},horizontalRule:function(){return this.execCommand("insertHTML",{value:"<hr/>"})},removeFormatting:function(t){return t.insertTextNode(t.textContent())},backColor:function(t,e){return t.wrap('<span style="background-color:'+e.value.toHex()+'">',!0)},overline:function(t){return t.wrap('<span style="text-decoration:overline">',!0)},style:function(t,e){return t.wrap('<span class="'+e.value+'">',!0)},replaceHTML:function(t,e){return this.content(e.value)},insertImage:function(t,e){return this.execCommand("insertHTML",{value:jQuery("<img/>",e.value)})},insertTable:function(t,e){return this.execCommand("insertHTML",{value:e.value})},insertLink:function(t,e){var i;return i=jQuery("<"+e.value.tagName+">",this.document).attr(e.value.attrs).html(e.value.content),t.insertNode(i)},replaceLink:function(t,e){var i,n;return i=jQuery("<"+e.value.tagName+">",this.document).attr(e.value.attrs).html(e.value.content),t.selectNode(e.node),n=jQuery("<div>").html(t.content()).find("a").html(),t.replace(jQuery(i,t.context).html(n))},insertSnippet:function(t,e){var i,n;return n=e.value,(i=this.element.find("[data-snippet="+n.identity+"]")).length&&t.selectNode(i.get(0)),t.insertNode(n.getHTML(this.document))},editSnippet:function(){var t;if(this.snippet)return t=Mercury.Snippet.find(this.snippet.data("snippet")),t.displayOptions()},removeSnippet:function(){return this.snippet&&this.snippet.remove(),Mercury.trigger("hide:toolbar",{type:"snippet",immediately:!0})}},n}(Mercury.Region),Mercury.Regions.Full.Selection=function(){function t(t,e){this.selection=t,this.context=e,this.selection.rangeCount>=1&&(this.range=this.selection.getRangeAt(0),this.fragment=this.range.cloneContents(),this.clone=this.range.cloneRange(),this.collapsed=this.selection.isCollapsed)}return t.prototype.commonAncestor=function(t){var e;return null==t&&(t=!1),this.range?(e=this.range.commonAncestorContainer,3===e.nodeType&&t&&(e=e.parentNode),jQuery(e)):null},t.prototype.wrap=function(t,e){return null==e&&(e=!1),t=jQuery(t,this.context).html(this.fragment),e&&this.replace(t),t},t.prototype.textContent=function(){return this.content().textContent},t.prototype.htmlContent=function(){var t;return t=this.content(),jQuery("<div>").html(t).html()},t.prototype.content=function(){return this.range.cloneContents()},t.prototype.is=function(t){var e;return e=this.content(),1===jQuery(e).length&&jQuery(e.firstChild).is(t)?jQuery(e.firstChild):!1},t.prototype.forceSelection=function(t){var e,i;if(jQuery.browser.webkit)return i=this.context.createRange(),this.range?this.commonAncestor(!0).closest("[data-snippet]").length&&(e=this.context.createTextNode("\0"),t.appendChild(e)):t.lastChild&&3===t.lastChild.nodeType&&""===t.lastChild.textContent.replace(/^[\s+|\n+]|[\s+|\n+]$/,"")?(e=t.lastChild,t.lastChild.textContent="\0"):(e=this.context.createTextNode("\0"),t.appendChild(e)),e?(i.setStartBefore(e),i.setEndBefore(e),this.selection.addRange(i)):void 0},t.prototype.selectMarker=function(t){var e,i;return e=t.find("em.mercury-marker"),e.length?(i=this.context.createRange(),i.setStartBefore(e.get(0)),e.length>=2&&i.setEndBefore(e.get(1)),e.remove(),this.selection.removeAllRanges(),this.selection.addRange(i)):void 0},t.prototype.placeMarker=function(){var t,e;if(this.range)return this.startMarker=jQuery('<em class="mercury-marker"/>',this.context).get(0),this.endMarker=jQuery('<em class="mercury-marker"/>',this.context).get(0),t=this.range.cloneRange(),t.collapse(!1),t.insertNode(this.endMarker),this.range.collapsed||(e=this.range.cloneRange(),e.collapse(!0),e.insertNode(this.startMarker)),this.selection.removeAllRanges(),this.selection.addRange(this.range)},t.prototype.removeMarker=function(){return jQuery(this.startMarker).remove(),jQuery(this.endMarker).remove()},t.prototype.insertTextNode=function(t){var e;return e=this.context.createTextNode(t),this.range.extractContents(),this.range.insertNode(e),this.range.selectNodeContents(e),this.selection.addRange(this.range)},t.prototype.insertNode=function(t){return t.get&&(t=t.get(0)),"string"===jQuery.type(t)&&(t=jQuery(t,this.context).get(0)),this.range.deleteContents(),this.range.insertNode(t),this.range.selectNodeContents(t),this.selection.addRange(this.range)},t.prototype.selectNode=function(t,e){return null==e&&(e=!1),this.range.selectNode(t),e&&this.selection.removeAllRanges(),this.selection.addRange(this.range)},t.prototype.replace=function(t,e){return t.get&&(t=t.get(0)),"string"===jQuery.type(t)&&(t=jQuery(t,this.context).get(0)),this.range.deleteContents(),this.range.insertNode(t),this.range.selectNodeContents(t),this.selection.addRange(this.range),e?this.range.collapse(!1):void 0},t}()}).call(this);