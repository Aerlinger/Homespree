(function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},n=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};this.Mercury.Regions.Full=function(e){function i(e,t,n){this.element=e,this.window=t,this.options=n!=null?n:{},i.__super__.constructor.apply(this,arguments)}var r;return t(i,e),i.supported=document.designMode&&!jQuery.browser.konqueror&&!jQuery.browser.msie,i.supportedText="Chrome 10+, Firefox 4+, Safari 5+, Opera 11.64+",r="full",i.prototype.type=function(){return r},i.prototype.build=function(){var e,t,n,r,i;jQuery.browser.mozilla&&this.content()===""&&this.content("&nbsp;"),this.element.data({originalOverflow:this.element.css("overflow")}),this.element.css({overflow:"auto"}),this.specialContainer=jQuery.browser.mozilla&&this.element.get(0).tagName!=="DIV",this.element.get(0).contentEditable=!0,i=this.element.find("[data-snippet]");for(n=0,r=i.length;n<r;n++)t=i[n],t.contentEditable=!1,jQuery(t).attr("data-version","1");if(!this.document.mercuryEditing){this.document.mercuryEditing=!0;try{return this.document.execCommand("styleWithCSS",!1,!1),this.document.execCommand("insertBROnReturn",!1,!0),this.document.execCommand("enableInlineTableEditing",!1,!1),this.document.execCommand("enableObjectResizing",!1,!1)}catch(s){e=s}}},i.prototype.bindEvents=function(){var e=this;return i.__super__.bindEvents.apply(this,arguments),Mercury.on("region:update",function(){var t,n,r;if(e.previewing||Mercury.region!==e)return;setTimeout(function(){return e.selection().forceSelection(e.element.get(0))},1),n=e.currentElement();if(n.length)return r=n.closest("table",e.element),r.length&&Mercury.tableEditor(r,n.closest("tr, td"),"<br/>"),t=n.closest("a",e.element),t.length&&t.attr("href")?Mercury.tooltip(t,'<a href="'+t.attr("href")+'" target="_blank">'+t.attr("href")+"</a>",{position:"below"}):Mercury.tooltip.hide()}),this.element.on("dragenter",function(t){if(e.previewing)return;return Mercury.snippet||t.preventDefault(),t.originalEvent.dataTransfer.dropEffect="copy"}),this.element.on("dragover",function(t){if(e.previewing)return;Mercury.snippet||t.preventDefault(),t.originalEvent.dataTransfer.dropEffect="copy";if(jQuery.browser.webkit)return clearTimeout(e.dropTimeout),e.dropTimeout=setTimeout(function(){return e.element.trigger("possible:drop")},10)}),this.element.on("drop",function(t){if(e.previewing)return;clearTimeout(e.dropTimeout),e.dropTimeout=setTimeout(function(){return e.element.trigger("possible:drop")},1);if(!t.originalEvent.dataTransfer.files.length)return;return t.preventDefault(),e.focus(),Mercury.uploader(t.originalEvent.dataTransfer.files[0])}),this.element.on("possible:drop",function(){var t;if(e.previewing)return;if(t=e.element.find("img[data-snippet]").get(0))return e.focus(),Mercury.Snippet.displayOptionsFor(jQuery(t).data("snippet"),{},jQuery(t).data("options")),e.document.execCommand("undo",!1,null)}),this.element.on("paste",function(t){if(e.previewing||Mercury.region!==e)return;if(e.specialContainer){t.preventDefault();return}if(e.pasting)return;return Mercury.changes=!0,e.handlePaste(t.originalEvent)}),this.element.on("focus",function(){if(e.previewing)return;return Mercury.region=e,setTimeout(function(){return e.selection().forceSelection(e.element.get(0))},1),Mercury.trigger("region:focused",{region:e})}),this.element.on("blur",function(){if(e.previewing)return;return Mercury.trigger("region:blurred",{region:e}),Mercury.tooltip.hide()}),this.element.on("click",function(t){if(e.previewing)return jQuery(t.target).closest("a").attr("target","_parent")}),this.element.on("dblclick",function(t){var n;if(e.previewing)return;n=jQuery(t.target).closest("img",e.element);if(n.length)return e.selection().selectNode(n.get(0),!0),Mercury.trigger("button",{action:"insertMedia"})}),this.element.on("mouseup",function(){if(e.previewing)return;return e.pushHistory(),Mercury.trigger("region:update",{region:e})}),this.element.on("keydown",function(t){var n;if(e.previewing)return;switch(t.keyCode){case 90:if(!t.metaKey)return;t.preventDefault(),t.shiftKey?e.execCommand("redo"):e.execCommand("undo");return;case 13:if(jQuery.browser.webkit&&e.selection().commonAncestor().closest("li, ul, ol",e.element).length===0)t.preventDefault(),e.document.execCommand("insertParagraph",!1,null);else if(e.specialContainer||jQuery.browser.opera)t.preventDefault(),e.document.execCommand("insertHTML",!1,"<br/>");break;case 9:t.preventDefault(),n=e.selection().commonAncestor(),n.closest("li",e.element).length?t.shiftKey?n.parents("ul, ol").length>1&&e.execCommand("outdent"):e.execCommand("indent"):e.execCommand("insertHTML",{value:"&nbsp;&nbsp;"})}if(t.metaKey)switch(t.keyCode){case 66:e.execCommand("bold"),t.preventDefault();break;case 73:e.execCommand("italic"),t.preventDefault();break;case 85:e.execCommand("underline"),t.preventDefault()}return e.pushHistory(t.keyCode)}),this.element.on("keyup",function(){if(e.previewing)return;return Mercury.trigger("region:update",{region:e}),Mercury.changes=!0})},i.prototype.focus=function(){var e,t=this;if(Mercury.region!==this){setTimeout(function(){return t.element.focus()},10);try{this.selection().selection.collapseToStart()}catch(n){e=n}}else setTimeout(function(){return t.element.focus()},10);return Mercury.trigger("region:focused",{region:this}),Mercury.trigger("region:update",{region:this})},i.prototype.content=function(e,t,n){var r,i,s,o,u,a,f,l,c,h,p,d,v,m;e==null&&(e=null),t==null&&(t=!0),n==null&&(n=!1);if(e!==null){r=jQuery("<div>").appendTo(this.document.createDocumentFragment()),r.html(e),v=r.find("[data-snippet]");for(c=0,p=v.length;c<p;c++){s=v[c],s.contentEditable=!1,s=jQuery(s);if(f=Mercury.Snippet.find(s.data("snippet")))if(s.data("version"))f.setVersion(s.data("version"));else try{l=parseInt(s.html().match(/\/(\d+)\]/)[1]),l&&(f.setVersion(l),s.attr({"data-version":l}),s.html(f.data))}catch(g){o=g}}return this.element.html(r.html()),this.selection().selectMarker(this.element)}this.element.find("meta").remove(),n&&(a=this.selection(),a.placeMarker()),r=jQuery("<div>").appendTo(this.document.createDocumentFragment()),r.html(this.element.html().replace(/^\s+|\s+$/g,""));if(t){m=r.find("[data-snippet]");for(u=h=0,d=m.length;h<d;u=++h){s=m[u],s=jQuery(s);if(f=Mercury.Snippet.find(s.data("snippet")))f.data=s.html();s.html("["+s.data("snippet")+"/"+s.data("version")+"]"),s.attr({contenteditable:null,"data-version":null})}}return i=r.html(),n&&a.removeMarker(),i},i.prototype.togglePreview=function(){return this.previewing?(this.element.get(0).contentEditable=!0,this.element.css({overflow:"auto"})):(this.content(this.content()),this.element.get(0).contentEditable=!1,this.element.css({overflow:this.element.data("originalOverflow")}),this.element.blur()),i.__super__.togglePreview.apply(this,arguments)},i.prototype.execCommand=function(e,t){var n,r,s;t==null&&(t={}),i.__super__.execCommand.apply(this,arguments);if(r=Mercury.config.behaviors[e]||Mercury.Regions.Full.actions[e])r.call(this,this.selection(),t);else{e==="indent"&&(s=this.element.get(0).previousSibling),e==="insertHTML"&&t.value&&t.value.get&&(t.value=jQuery("<div>").html(t.value).html());try{this.document.execCommand(e,!1,t.value)}catch(o){n=o,e==="indent"&&this.element.prev()!==s&&this.element.prev().remove()}}return this.element.find("img").one("error",function(){return jQuery(this).attr({src:"/assets/mercury/missing-image.png",title:"Image not found"})})},i.prototype.pushHistory=function(e){var t,n,r,i=this;return t=[13,46,8],r=2.5,e&&(n=t.indexOf(e)),clearTimeout(this.historyTimeout),n>=0&&n!==this.lastKnownKeyCode?this.history.push(this.content(null,!1,!0)):e?this.historyTimeout=setTimeout(function(){return i.history.push(i.content(null,!1,!0))},r*1e3):this.history.push(this.content(null,!1,!0)),this.lastKnownKeyCode=n},i.prototype.selection=function(){return new Mercury.Regions.Full.Selection(this.window.getSelection(),this.document)},i.prototype.path=function(){var e;return e=this.selection().commonAncestor(),e?e.get(0)===this.element.get(0)?[]:e.parentsUntil(this.element):[]},i.prototype.currentElement=function(){var e,t;return e=[],t=this.selection(),t.range&&(e=t.commonAncestor(),e.get(0).nodeType===3&&(e=e.parent())),e},i.prototype.handlePaste=function(e){var t,n,r=this;if(Mercury.config.pasting.sanitize!=="text"||!e.clipboardData)return n=this.selection(),n.placeMarker(),t=jQuery("#mercury_sanitizer",this.document).focus(),setTimeout(function(){var e;return e=r.sanitize(t),n.selectMarker(r.element),n.removeMarker(),r.element.focus(),r.execCommand("insertHTML",{value:e})},1);this.execCommand("insertHTML",{value:e.clipboardData.getData("text/plain")}),e.preventDefault()},i.prototype.sanitize=function(e){var t,r,i,s,o,u,a,f,l,c,h,p,d,v;e.find("["+Mercury.config.regions.attribute+"]").remove(),e.find('[src*="webkit-fake-url://"]').remove();if(Mercury.config.pasting.sanitize)switch(Mercury.config.pasting.sanitize){case"blacklist":e.find("[style]").removeAttr("style"),e.find('[class="Apple-style-span"]').removeClass("Apple-style-span"),o=e.html();break;case"whitelist":h=e.find("*");for(a=0,l=h.length;a<l;a++){u=h[a],t=!1,p=Mercury.config.pasting.whitelist;for(i in p){r=p[i];if(u.tagName.toLowerCase()===i.toLowerCase()){t=!0,d=jQuery(u.attributes);for(f=0,c=d.length;f<c;f++)s=d[f],(v=s.name,n.call(r,v)<0)&&jQuery(u).removeAttr(s.name);break}}t||jQuery(u).replaceWith(jQuery(u).contents())}o=e.html();break;default:o=e.text()}else{o=e.html();if(o.indexOf("<!--StartFragment-->")>-1||o.indexOf('="mso-')>-1||o.indexOf("<o:")>-1||o.indexOf('="Mso')>-1)o=e.text()}return e.html(""),o},i.actions={insertRowBefore:function(){return Mercury.tableEditor.addRow("before")},insertRowAfter:function(){return Mercury.tableEditor.addRow("after")},insertColumnBefore:function(){return Mercury.tableEditor.addColumn("before")},insertColumnAfter:function(){return Mercury.tableEditor.addColumn("after")},deleteColumn:function(){return Mercury.tableEditor.removeColumn()},deleteRow:function(){return Mercury.tableEditor.removeRow()},increaseColspan:function(){return Mercury.tableEditor.increaseColspan()},decreaseColspan:function(){return Mercury.tableEditor.decreaseColspan()},increaseRowspan:function(){return Mercury.tableEditor.increaseRowspan()},decreaseRowspan:function(){return Mercury.tableEditor.decreaseRowspan()},undo:function(){return this.content(this.history.undo())},redo:function(){return this.content(this.history.redo())},horizontalRule:function(){return this.execCommand("insertHTML",{value:"<hr/>"})},removeFormatting:function(e){return e.insertTextNode(e.textContent())},backColor:function(e,t){return e.wrap('<span style="background-color:'+t.value.toHex()+'">',!0)},overline:function(e){return e.wrap('<span style="text-decoration:overline">',!0)},style:function(e,t){return e.wrap('<span class="'+t.value+'">',!0)},replaceHTML:function(e,t){return this.content(t.value)},insertImage:function(e,t){return this.execCommand("insertHTML",{value:jQuery("<img/>",t.value)})},insertTable:function(e,t){return this.execCommand("insertHTML",{value:t.value})},insertLink:function(e,t){var n;return n=jQuery("<"+t.value.tagName+">",this.document).attr(t.value.attrs).html(t.value.content),e.insertNode(n)},replaceLink:function(e,t){var n,r;return n=jQuery("<"+t.value.tagName+">",this.document).attr(t.value.attrs).html(t.value.content),e.selectNode(t.node),r=jQuery("<div>").html(e.content()).find("a").html(),e.replace(jQuery(n,e.context).html(r))},insertSnippet:function(e,t){var n,r;return r=t.value,(n=this.element.find("[data-snippet="+r.identity+"]")).length&&e.selectNode(n.get(0)),e.insertNode(r.getHTML(this.document))},editSnippet:function(){var e;if(!this.snippet)return;return e=Mercury.Snippet.find(this.snippet.data("snippet")),e.displayOptions()},removeSnippet:function(){return this.snippet&&this.snippet.remove(),Mercury.trigger("hide:toolbar",{type:"snippet",immediately:!0})}},i}(Mercury.Region),Mercury.Regions.Full.Selection=function(){function e(e,t){this.selection=e,this.context=t;if(!(this.selection.rangeCount>=1))return;this.range=this.selection.getRangeAt(0),this.fragment=this.range.cloneContents(),this.clone=this.range.cloneRange(),this.collapsed=this.selection.isCollapsed}return e.prototype.commonAncestor=function(e){var t;return e==null&&(e=!1),this.range?(t=this.range.commonAncestorContainer,t.nodeType===3&&e&&(t=t.parentNode),jQuery(t)):null},e.prototype.wrap=function(e,t){return t==null&&(t=!1),e=jQuery(e,this.context).html(this.fragment),t&&this.replace(e),e},e.prototype.textContent=function(){return this.content().textContent},e.prototype.htmlContent=function(){var e;return e=this.content(),jQuery("<div>").html(e).html()},e.prototype.content=function(){return this.range.cloneContents()},e.prototype.is=function(e){var t;return t=this.content(),jQuery(t).length===1&&jQuery(t.firstChild).is(e)?jQuery(t.firstChild):!1},e.prototype.forceSelection=function(e){var t,n;if(!jQuery.browser.webkit)return;n=this.context.createRange(),this.range?this.commonAncestor(!0).closest("[data-snippet]").length&&(t=this.context.createTextNode("\0"),e.appendChild(t)):e.lastChild&&e.lastChild.nodeType===3&&e.lastChild.textContent.replace(/^[\s+|\n+]|[\s+|\n+]$/,"")===""?(t=e.lastChild,e.lastChild.textContent="\0"):(t=this.context.createTextNode("\0"),e.appendChild(t));if(t)return n.setStartBefore(t),n.setEndBefore(t),this.selection.addRange(n)},e.prototype.selectMarker=function(e){var t,n;t=e.find("em.mercury-marker");if(!t.length)return;return n=this.context.createRange(),n.setStartBefore(t.get(0)),t.length>=2&&n.setEndBefore(t.get(1)),t.remove(),this.selection.removeAllRanges(),this.selection.addRange(n)},e.prototype.placeMarker=function(){var e,t;if(!this.range)return;return this.startMarker=jQuery('<em class="mercury-marker"/>',this.context).get(0),this.endMarker=jQuery('<em class="mercury-marker"/>',this.context).get(0),e=this.range.cloneRange(),e.collapse(!1),e.insertNode(this.endMarker),this.range.collapsed||(t=this.range.cloneRange(),t.collapse(!0),t.insertNode(this.startMarker)),this.selection.removeAllRanges(),this.selection.addRange(this.range)},e.prototype.removeMarker=function(){return jQuery(this.startMarker).remove(),jQuery(this.endMarker).remove()},e.prototype.insertTextNode=function(e){var t;return t=this.context.createTextNode(e),this.range.extractContents(),this.range.insertNode(t),this.range.selectNodeContents(t),this.selection.addRange(this.range)},e.prototype.insertNode=function(e){return e.get&&(e=e.get(0)),jQuery.type(e)==="string"&&(e=jQuery(e,this.context).get(0)),this.range.deleteContents(),this.range.insertNode(e),this.range.selectNodeContents(e),this.selection.addRange(this.range)},e.prototype.selectNode=function(e,t){return t==null&&(t=!1),this.range.selectNode(e),t&&this.selection.removeAllRanges(),this.selection.addRange(this.range)},e.prototype.replace=function(e,t){e.get&&(e=e.get(0)),jQuery.type(e)==="string"&&(e=jQuery(e,this.context).get(0)),this.range.deleteContents(),this.range.insertNode(e),this.range.selectNodeContents(e),this.selection.addRange(this.range);if(t)return this.range.collapse(!1)},e}()}).call(this);