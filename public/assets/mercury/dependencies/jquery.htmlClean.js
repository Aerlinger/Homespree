/*
 HTML Clean for jQuery
 Anthony Johnston
 http://www.antix.co.uk

 version 1.2.3

 $Revision: 51 $

 requires jQuery http://jquery.com

 Use and distibution http://www.opensource.org/licenses/bsd-license.php

 2010-04-02 allowedTags/removeTags added (white/black list) thanks to David Wartian (Dwartian)
 2010-06-30 replaceStyles added for replacement of bold, italic, super and sub styles on a tag
 2010-07-01 notRenderedTags added, where tags are to be removed but their contents are kept
 */
(function(e){function t(e,t,n,r){if(!e.tag.isInline&&n.length>0){n.push("\n");for(var i=0;i<r;i++)n.push("	")}}function n(r,i){var s=[],o=r.attributes.length==0,c=0,p=null,d=r.tag.render&&(i.allowedTags.length==0||e.inArray(r.tag.name,i.allowedTags)>-1)&&(i.removeTags.length==0||e.inArray(r.tag.name,i.removeTags)==-1);!r.isRoot&&d&&(s.push("<"),s.push(r.tag.name),e.each(r.attributes,function(){if(e.inArray(this.name,i.removeAttrs)==-1){var t=(new RegExp(/^(['"]?)(.*?)['"]?$/)).exec(this.value),n=t[2],o=t[1]||"'";this.name=="class"&&(n=e.grep(n.split(" "),function(t){return e.grep(i.allowedClasses,function(n){return n[0]==t&&(n.length==1||e.inArray(r.tag.name,n[1])>-1)}).length>0}).join(" "),o="'"),n!=null&&(n.length>0||e.inArray(this.name,r.tag.requiredAttributes)>-1)&&(s.push(" "),s.push(this.name),s.push("="),s.push(o),s.push(n),s.push(o))}}));if(r.tag.isSelfClosing)d&&s.push(" />"),o=!1;else if(r.tag.isNonClosing)o=!1;else{!r.isRoot&&d&&s.push(">"),c=i.formatIndent++;if(r.tag.toProtect)p=e.htmlClean.trim(r.children.join("")).replace(/<br>/ig,"\n"),s.push(p),o=p.length==0,i.formatIndent--;else{p=[];for(var v=0;v<r.children.length;v++){var m=r.children[v],g=e.htmlClean.trim(h(f(m)?m:m.childrenToString()));l(m)&&v>0&&g.length>0&&(u(m)||a(r.children[v-1]))&&p.push(" ");if(f(m))g.length>0&&p.push(g);else if(v!=r.children.length-1||m.tag.name!="br")i.format&&t(m,i,p,c),p=p.concat(n(m,i))}i.formatIndent--,p.length>0&&(i.format&&p[0]!="\n"&&t(r,i,s,c),s=s.concat(p),o=!1)}!r.isRoot&&d&&(i.format&&t(r,i,s,c-1),s.push("</"),s.push(r.tag.name),s.push(">"))}return!r.tag.allowEmpty&&o?[]:s}function r(t,n,i){return i=i||1,e.inArray(t[t.length-i].tag.name,n)>-1?!0:t.length-(i+1)>0&&r(t,n,i+1)?(t.pop(),!0):!1}function i(e){return e?(this.tag=e,this.isRoot=!1):(this.tag=new o("root"),this.isRoot=!0),this.attributes=[],this.children=[],this.hasAttribute=function(e){for(var t=0;t<this.attributes.length;t++)if(this.attributes[t].name==e)return!0;return!1},this.childrenToString=function(){return this.children.join("")},this}function s(e,t){return this.name=e,this.value=t,this}function o(t,n,r,i){return this.name=t.toLowerCase(),this.isSelfClosing=e.inArray(this.name,y)>-1,this.isNonClosing=e.inArray(this.name,b)>-1,this.isClosing=n!=undefined&&n.length>0,this.isInline=e.inArray(this.name,p)>-1,this.disallowNest=e.inArray(this.name,d)>-1,this.requiredParent=m[e.inArray(this.name,m)+1],this.allowEmpty=e.inArray(this.name,v)>-1,this.toProtect=e.inArray(this.name,g)>-1,this.rawAttributes=r,this.allowedAttributes=w[e.inArray(this.name,w)+1],this.requiredAttributes=E[e.inArray(this.name,E)+1],this.render=i&&e.inArray(this.name,i.notRenderedTags)==-1,this}function u(t){while(c(t)&&t.children.length>0)t=t.children[0];return f(t)&&t.length>0&&e.htmlClean.isWhitespace(t.charAt(0))}function a(t){while(c(t)&&t.children.length>0)t=t.children[t.children.length-1];return f(t)&&t.length>0&&e.htmlClean.isWhitespace(t.charAt(t.length-1))}function f(e){return e.constructor==String}function l(e){return f(e)||e.tag.isInline}function c(e){return e.constructor==i}function h(e){return e.replace(/&nbsp;|\n/g," ").replace(/\s\s+/g," ")}e.fn.htmlClean=function(t){return this.each(function(){this.value?this.value=e.htmlClean(this.value,t):this.innerHTML=e.htmlClean(this.innerHTML,t)})},e.htmlClean=function(t,u){u=e.extend({},e.htmlClean.defaults,u);var a=/<(\/)?(\w+:)?([\w]+)([^>]*)>/gi,l=/(\w+)=(".*?"|'.*?'|[^\s>]*)/gi,c,h=new i,p=[h],d=h;u.bodyOnly&&(c=/<body[^>]*>((\n|.)*)<\/body>/i.exec(t))&&(t=c[1]),t=t.concat("<xxx>");var v;while(c=a.exec(t)){var m=new o(c[3],c[1],c[4],u),g=t.substring(v,c.index);if(g.length>0){var y=d.children[d.children.length-1];d.children.length>0&&f(y=d.children[d.children.length-1])?d.children[d.children.length-1]=y.concat(g):d.children.push(g)}v=a.lastIndex;if(m.isClosing)r(p,[m.name])&&(p.pop(),d=p[p.length-1]);else{var b=new i(m),w;while(w=l.exec(m.rawAttributes)){if(w[1].toLowerCase()=="style"&&u.replaceStyles){var E=!m.isInline;for(var S=0;S<u.replaceStyles.length;S++)u.replaceStyles[S][0].test(w[2])&&(E||(m.render=!1,E=!0),d.children.push(b),p.push(b),d=b,m=new o(u.replaceStyles[S][1],"","",u),b=new i(m))}m.allowedAttributes!=null&&(m.allowedAttributes.length==0||e.inArray(w[1],m.allowedAttributes)>-1)&&b.attributes.push(new s(w[1],w[2]))}e.each(m.requiredAttributes,function(){var e=this.toString();b.hasAttribute(e)||b.attributes.push(new s(e,""))});for(var x=0;x<u.replace.length;x++)for(var T=0;T<u.replace[x][0].length;T++){var N=typeof u.replace[x][0][T]=="string";if(N&&u.replace[x][0][T]==m.name||!N&&u.replace[x][0][T].test(c)){m.render=!1,d.children.push(b),p.push(b),d=b,m=new o(u.replace[x][1],c[1],c[4],u),b=new i(m),b.attributes=d.attributes,x=u.replace.length;break}}var C=!0;d.isRoot||(d.tag.isInline&&!m.isInline?C=!1:d.tag.disallowNest&&m.disallowNest&&!m.requiredParent?C=!1:m.requiredParent&&(C=r(p,m.requiredParent))&&(d=p[p.length-1]));if(C){d.children.push(b);if(m.toProtect){var k=null;while(k=a.exec(t)){var L=new o(k[3],k[1],k[4],u);if(L.isClosing&&L.name==m.name){b.children.push(RegExp.leftContext.substring(v)),v=a.lastIndex;break}}}else!m.isSelfClosing&&!m.isNonClosing&&(p.push(b),d=b)}}}return n(h,u).join("")},e.htmlClean.defaults={bodyOnly:!0,allowedTags:[],removeTags:["basefont","center","dir","font","frame","frameset","iframe","isindex","menu","noframes","s","strike","u"],removeAttrs:[],allowedClasses:[],notRenderedTags:[],format:!1,formatIndent:0,replace:[[["b","big"],"strong"],[["i"],"em"]],replaceStyles:[[/font-weight:\s*bold/i,"strong"],[/font-style:\s*italic/i,"em"],[/vertical-align:\s*super/i,"sup"],[/vertical-align:\s*sub/i,"sub"]]},e.htmlClean.trim=function(t){return e.htmlClean.trimStart(e.htmlClean.trimEnd(t))},e.htmlClean.trimStart=function(t){return t.substring(e.htmlClean.trimStartIndex(t))},e.htmlClean.trimStartIndex=function(t){for(var n=0;n<t.length-1&&e.htmlClean.isWhitespace(t.charAt(n));n++);return n},e.htmlClean.trimEnd=function(t){return t.substring(0,e.htmlClean.trimEndIndex(t))},e.htmlClean.trimEndIndex=function(t){for(var n=t.length-1;n>=0&&e.htmlClean.isWhitespace(t.charAt(n));n--);return n+1},e.htmlClean.isWhitespace=function(t){return e.inArray(t,S)!=-1};var p=["a","abbr","acronym","address","b","big","br","button","caption","cite","code","del","em","font","hr","i","input","img","ins","label","legend","map","q","samp","select","small","span","strong","sub","sup","tt","var"],d=["h1","h2","h3","h4","h5","h6","p","th","td"],v=["th","td"],m=[null,"li",["ul","ol"],"dt",["dl"],"dd",["dl"],"td",["tr"],"th",["tr"],"tr",["table","thead","tbody","tfoot"],"thead",["table"],"tbody",["table"],"tfoot",["table"]],g=["script","style","pre","code"],y=["br","hr","img","link","meta"],b=["!doctype","?xml"],w=[["class"],"?xml",[],"!doctype",[],"a",["accesskey","class","href","name","title","rel","rev","type","tabindex"],"abbr",["class","title"],"acronym",["class","title"],"blockquote",["cite","class"],"button",["class","disabled","name","type","value"],"del",["cite","class","datetime"],"form",["accept","action","class","enctype","method","name"],"input",["accept","accesskey","alt","checked","class","disabled","ismap","maxlength","name","size","readonly","src","tabindex","type","usemap","value"],"img",["alt","class","height","src","width"],"ins",["cite","class","datetime"],"label",["accesskey","class","for"],"legend",["accesskey","class"],"link",["href","rel","type"],"meta",["content","http-equiv","name","scheme"],"map",["name"],"optgroup",["class","disabled","label"],"option",["class","disabled","label","selected","value"],"q",["class","cite"],"td",["colspan","rowspan"],"th",["colspan","rowspan"],"script",["src","type"],"select",["class","disabled","multiple","name","size","tabindex"],"style",["type"],"table",["class","summary"],"textarea",["accesskey","class","cols","disabled","name","readonly","rows","tabindex"]],E=[[],"img",["alt"]],S=["Â "," ","	","\n","\r","\f"]})(jQuery);