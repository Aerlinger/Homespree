(function(){this.Mercury.tableEditor=function(t,e,i){return Mercury.tableEditor.load(t,e,i),Mercury.tableEditor},jQuery.extend(Mercury.tableEditor,{load:function(t,e,i){return this.table=t,this.cell=e,this.cellContent=null!=i?i:"",this.row=this.cell.parent("tr"),this.columnCount=this.getColumnCount(),this.rowCount=this.getRowCount()},addColumnBefore:function(){return this.addColumn("before")},addColumnAfter:function(){return this.addColumn("after")},addColumn:function(t){var e,i,n,s,r,o,a,l,c,u,h,d;for(null==t&&(t="after"),l=this.cellSignatureFor(this.cell),h=this.table.find("tr"),d=[],e=c=0,u=h.length;u>c;e=++c)o=h[e],a=1,n="after"===t?{right:l.right}:{left:l.left},(s=this.findCellByOptionsFor(o,n))?(r=jQuery("<"+s.cell.get(0).tagName+">").html(this.cellContent),this.setRowspanFor(r,s.height),"before"===t?s.cell.before(r):s.cell.after(r),d.push(e+=s.height-1)):(i=this.findCellByIntersectionFor(o,l))?d.push(this.setColspanFor(i.cell,i.width+1)):d.push(void 0);return d},removeColumn:function(){var t,e,i,n,s,r,o,a,l,c,u,h,d,p,f,m;if(a=this.cellSignatureFor(this.cell),!(a.width>1)){for(r=[],t=[],f=this.table.find("tr"),i=l=0,h=f.length;h>l;i=++l)o=f[i],(s=this.findCellByOptionsFor(o,{left:a.left,width:a.width}))?(r.push(s.cell),i+=s.height-1):(n=this.findCellByIntersectionFor(o,a))&&t.push(n.cell);for(c=0,d=r.length;d>c;c++)e=r[c],jQuery(e).remove();for(m=[],u=0,p=t.length;p>u;u++)e=t[u],m.push(this.setColspanFor(e,this.colspanFor(e)-1));return m}},addRowBefore:function(){return this.addRow("before")},addRowAfter:function(){return this.addRow("after")},addRow:function(t){var e,i,n,s,r,o,a,l,c,u,h,d,p,f,m,g,v;for(null==t&&(t="after"),r=jQuery("<tr>"),(l=this.rowspanFor(this.cell))>1&&"after"===t&&(this.row=jQuery(this.row.nextAll("tr")[l-2])),i=0,m=this.row.find("th, td"),c=0,d=m.length;d>c;c++)e=m[c],n=this.colspanFor(e),s=jQuery("<"+e.tagName+">").html(this.cellContent),this.setColspanFor(s,n),i+=n,(l=this.rowspanFor(e))>1&&"after"===t?this.setRowspanFor(e,l+1):r.append(s);if(this.columnCount>i)for(a=0,g=this.row.prevAll("tr"),u=0,p=g.length;p>u;u++)for(o=g[u],a+=1,v=jQuery(o).find("td[rowspan], th[rowspan]"),h=0,f=v.length;f>h;h++)e=v[h],l=this.rowspanFor(e),l-1>=a&&"before"===t?this.setRowspanFor(e,l+1):l-1>=a&&"after"===t&&(l-1===a?(s=jQuery("<"+e.tagName+">").html(this.cellContent),this.setColspanFor(s,this.colspanFor(e)),r.append(s)):this.setRowspanFor(e,l+1));return"before"===t?this.row.before(r):this.row.after(r)},removeRow:function(){var t,e,i,n,s,r,o,a,l,c,u,h,d,p,f,m,g,v,y,b,w,_,x,C;for(l=!0,r=0,s=0,b=this.row.find("td, th"),u=0,f=b.length;f>u;u++)e=b[u],a=this.rowspanFor(e),r&&a!==r&&(l=!1),(s>a||!s)&&(s=a),r=a;if(l||!(this.rowspanFor(this.cell)>s)){if(s>1)for(i=h=0,w=s-2;w>=0?w>=h:h>=w;i=w>=0?++h:--h)jQuery(this.row.nextAll("tr")[i]).remove();for(_=this.row.find("td[rowspan], th[rowspan]"),d=0,m=_.length;m>d;d++)e=_[d],c=this.cellSignatureFor(e),c.height!==s&&(n=this.findCellByOptionsFor(this.row.nextAll("tr")[s-1],{left:c.left,forceAdjacent:!0}))&&(this.setRowspanFor(e,this.rowspanFor(e)-this.rowspanFor(this.cell)),"before"===n.direction?n.cell.before(jQuery(e).clone()):n.cell.after(jQuery(e).clone()));if(this.columnsFor(this.row.find("td, th"))<this.columnCount)for(o=0,x=this.row.prevAll("tr"),p=0,g=x.length;g>p;p++)for(t=x[p],o+=1,C=jQuery(t).find("td[rowspan], th[rowspan]"),y=0,v=C.length;v>y;y++)e=C[y],a=this.rowspanFor(e),a>o&&this.setRowspanFor(e,a-this.rowspanFor(this.cell));return this.row.remove()}},increaseColspan:function(){var t;return t=this.cell.next("td, th"),!t.length||this.rowspanFor(t)!==this.rowspanFor(this.cell)||this.cellIndexFor(t)>this.cellIndexFor(this.cell)+this.colspanFor(this.cell)?void 0:(this.setColspanFor(this.cell,this.colspanFor(this.cell)+this.colspanFor(t)),t.remove())},decreaseColspan:function(){var t;if(1!==this.colspanFor(this.cell))return this.setColspanFor(this.cell,this.colspanFor(this.cell)-1),t=jQuery("<"+this.cell.get(0).tagName+">").html(this.cellContent),this.setRowspanFor(t,this.rowspanFor(this.cell)),this.cell.after(t)},increaseRowspan:function(){var t,e,i;return i=this.cellSignatureFor(this.cell),e=this.row.nextAll("tr")[i.height-1],e&&(t=this.findCellByOptionsFor(e,{left:i.left,width:i.width}))?(this.setRowspanFor(this.cell,i.height+t.height),t.cell.remove()):void 0},decreaseRowspan:function(){var t,e,i,n;return n=this.cellSignatureFor(this.cell),1!==n.height?(i=this.row.nextAll("tr")[n.height-2],(t=this.findCellByOptionsFor(i,{left:n.left,forceAdjacent:!0}))?(e=jQuery("<"+this.cell.get(0).tagName+">").html(this.cellContent),this.setColspanFor(e,this.colspanFor(this.cell)),this.setRowspanFor(this.cell,n.height-1),"before"===t.direction?t.cell.before(e):t.cell.after(e)):void 0):void 0},getColumnCount:function(){return this.columnsFor(this.table.find("thead tr:first-child, tbody tr:first-child, tfoot tr:first-child").first().find("td, th"))},getRowCount:function(){return this.table.find("tr").length},cellIndexFor:function(t){var e,i,n,s,r,o,a,l,c,u,h,d;if(t=jQuery(t),r=t.parent("tr"),n=this.columnsFor(r.find("td, th")),s=this.columnsFor(t.prevAll("td, th")),this.columnCount>n)for(o=0,h=r.prevAll("tr"),a=0,c=h.length;c>a;a++)for(i=h[a],o+=1,d=jQuery(i).find("td[rowspan], th[rowspan]"),l=0,u=d.length;u>l;l++)e=d[l],this.rowspanFor(e)>o&&s>=this.cellIndexFor(e)&&(s+=this.colspanFor(e));return s},cellSignatureFor:function(t){var e;return e={cell:jQuery(t)},e.left=this.cellIndexFor(t),e.width=this.colspanFor(t),e.height=this.rowspanFor(t),e.right=e.left+e.width,e},findCellByOptionsFor:function(t,e){var i,n,s,r,o,a;for(a=jQuery(t).find("td, th"),r=0,o=a.length;o>r;r++){if(i=a[r],s=this.cellSignatureFor(i),"undefined"!=typeof e.right&&s.right===e.right)return s;if("undefined"!=typeof e.left)if(e.width){if(s.left===e.left&&s.width===e.width)return s}else if(e.forceAdjacent){if(e.forceAdjacent&&s.left>e.left)return n=jQuery(i).prev("td, th"),n.length?(s=this.cellSignatureFor(n),s.direction="after"):s.direction="before",s}else if(s.left===e.left)return s}return e.forceAdjacent?(s.direction="after",s):null},findCellByIntersectionFor:function(t,e){var i,n,s,r,o;for(o=jQuery(t).find("td, th"),s=0,r=o.length;r>s;s++)if(i=o[s],n=this.cellSignatureFor(i),n.right-e.left>=0&&n.right>e.left)return n;return null},columnsFor:function(t){var e,i,n,s;for(i=0,n=0,s=t.length;s>n;n++)e=t[n],i+=this.colspanFor(e);return i},colspanFor:function(t){return parseInt(jQuery(t).attr("colspan"))||1},rowspanFor:function(t){return parseInt(jQuery(t).attr("rowspan"))||1},setColspanFor:function(t,e){return jQuery(t).attr("colspan",e>1?e:null)},setRowspanFor:function(t,e){return jQuery(t).attr("rowspan",e>1?e:null)}})}).call(this);